<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Login DANA Rewards</title>

<!-- Firebase SDK -->
<script type="module">
  // Import Firebase
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
  import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
  import { getFirestore, doc, setDoc, getDoc, updateDoc, arrayUnion, increment } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

  // Your web app's Firebase configuration
  const firebaseConfig = {
    apiKey: "AIzaSyAlXIQ42acjO8xZH-Ti__YL6h9SGQQKQto",
    authDomain: "govminer.firebaseapp.com",
    projectId: "govminer",
    storageBucket: "govminer.firebasestorage.app",
    messagingSenderId: "408110658500",
    appId: "1:408110658500:web:3fe7f4bd9a35f3fe726a91"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // Ekspor ke global scope agar bisa diakses oleh kode lain
  window.firebaseAuth = auth;
  window.firebaseDb = db;
  window.firebaseFunctions = {
    createUserWithEmailAndPassword,
    signInWithEmailAndPassword,
    doc,
    setDoc,
    getDoc,
    updateDoc,
    arrayUnion,
    increment
  };
</script>
  
<style>
  body {
    background-color: #F9F6EE;
    font-family: Arial, sans-serif;
    margin: 0;
    padding: 0;
  }
  /* Splash screen */
  #splash {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background-color: #F9F6EE;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    z-index: 9999;
  }
  /* Loading spinner */
  .spinner {
    margin-top: 20px;
    border: 6px solid #ddd;
    border-top: 6px solid #1877f2;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    animation: spin 1s linear infinite;
  }
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
  /* Main content */
  .main-content {
    display: none;
    padding: 20px;
    display: flex;
    flex-direction: column;
    align-items: center;
  }
  .logo {
    width: 180px;
    margin: 30px auto 10px auto;
  }
  .login-container, .register-container {
    background-color: white;
    border-radius: 8px;
    padding: 20px;
    width: 280px;
    box-shadow: 0 3px 5px rgba(0,0,0,0.1);
    text-align: center;
    margin-bottom: 20px;
    display: none;
  }
  .login-container.active, .register-container.active {
    display: block;
  }
  h1 {
    color: #333;
    margin-bottom: 20px;
    font-size: 18px;
  }
  input {
    width: 100%;
    padding: 10px;
    margin-bottom: 10px;
    border: 1px solid #ddd;
    border-radius: 6px;
    font-size: 14px;
  }
  button {
    width: 100%;
    padding: 12px;
    border: none;
    border-radius: 6px;
    font-size: 16px;
    font-weight: bold;
    cursor: pointer;
    margin-top: 8px;
  }
  #loginBtn, #registerBtn {
    background-color: #1877f2;
    color: white;
  }
  .register-link, .login-link {
    margin-top: 15px;
    font-size: 14px;
    color: #1877f2;
    cursor: pointer;
    display: block;
    text-decoration: none;
  }
  .error-message {
    color: red;
    font-size: 14px;
    margin-top: 10px;
    display: none;
  }
</style>
</head>
<body>

<!-- Splash Screen -->
<div id="splash">
  <img src="https://i.postimg.cc/x8XVRwZS/file-00000000f3d06230a63b9cde063aaecc-1.png" alt="Logo DANA" style="width: 220px;">
  <div class="spinner"></div>
</div>

<!-- Main Login Content -->
<div id="main-content" class="main-content">
  <img src="https://i.postimg.cc/x8XVRwZS/file-00000000f3d06230a63b9cde063aaecc-1.png" alt="Logo DANA" class="logo">
  
  <!-- Login Form -->
  <div class="login-container active" id="loginForm">
    <h1>LOGIN</h1>
    <input type="text" id="loginEmail" placeholder="Email">
    <input type="password" id="loginPassword" placeholder="Kata sandi">
    <div id="loginError" class="error-message"></div>
    <button id="loginBtn">Login</button>
    <a class="register-link" id="showRegister">Belum punya akun? Daftar</a>
  </div>

  <!-- Register Form -->
  <div class="register-container" id="registerForm">
    <h1>DAFTAR</h1>
    <input type="text" id="registerName" placeholder="Nama lengkap">
    <input type="email" id="registerEmail" placeholder="Email">
    <input type="password" id="registerPassword" placeholder="Kata sandi">
    <input type="password" id="registerConfirmPassword" placeholder="Konfirmasi kata sandi">
    <div id="registerError" class="error-message"></div>
    <button id="registerBtn">Daftar</button>
    <a class="login-link" id="showLogin">Sudah punya akun? Login</a>
  </div>
</div>

<script>
// === Referral Tracking ===
const urlParams = new URLSearchParams(window.location.search);
const referrer = urlParams.get('ref');
if (referrer) {
    localStorage.setItem("invitedBy", referrer);
}

// Splash Screen delay
window.addEventListener("load", function () {
  setTimeout(() => {
    document.getElementById("splash").style.display = "none";
    document.getElementById("main-content").style.display = "flex";
  }, 2000);
});

// Toggle Login/Register
document.getElementById("showRegister").addEventListener("click", function() {
  document.getElementById("loginForm").classList.remove("active");
  document.getElementById("registerForm").classList.add("active");
});
document.getElementById("showLogin").addEventListener("click", function() {
  document.getElementById("registerForm").classList.remove("active");
  document.getElementById("loginForm").classList.add("active");
});

// Fungsi untuk menampilkan error
function showError(elementId, message) {
  const errorElement = document.getElementById(elementId);
  errorElement.textContent = message;
  errorElement.style.display = "block";
}

function hideError(elementId) {
  const errorElement = document.getElementById(elementId);
  errorElement.style.display = "none";
}

// === FIREBASE LOGIN ===
document.getElementById("loginBtn").addEventListener("click", async function() {
  const email = document.getElementById("loginEmail").value;
  const password = document.getElementById("loginPassword").value;
  
  hideError("loginError");
  
  if (!email || !password) {
    showError("loginError", "Harap isi email dan password");
    return;
  }
  
  try {
    // Login dengan Firebase Authentication
    const userCredential = await window.firebaseFunctions.signInWithEmailAndPassword(
      window.firebaseAuth, 
      email, 
      password
    );
    
    const user = userCredential.user;
    
    // Simpan info user di localStorage untuk akses cepat
    localStorage.setItem("currentUser", user.email);
    localStorage.setItem("userId", user.uid);
    
    alert("Login berhasil!");
    window.location.href = "dashboard.html";
    
  } catch (error) {
    console.error("Login error:", error);
    let errorMessage = "Login gagal";
    
    if (error.code === 'auth/user-not-found') {
      errorMessage = "Email tidak ditemukan";
    } else if (error.code === 'auth/wrong-password') {
      errorMessage = "Password salah";
    } else if (error.code === 'auth/invalid-email') {
      errorMessage = "Format email tidak valid";
    } else if (error.code === 'auth/too-many-requests') {
      errorMessage = "Terlalu banyak percobaan gagal. Coba lagi nanti";
    }
    
    showError("loginError", errorMessage);
  }
});

// === FIREBASE REGISTER ===
document.getElementById("registerBtn").addEventListener("click", async function() {
  const name = document.getElementById("registerName").value;
  const email = document.getElementById("registerEmail").value;
  const password = document.getElementById("registerPassword").value;
  const confirmPassword = document.getElementById("registerConfirmPassword").value;
  
  hideError("registerError");
  
  // Validasi
  if (!name || !email || !password || !confirmPassword) {
    showError("registerError", "Harap isi semua field");
    return;
  }
  if (password !== confirmPassword) {
    showError("registerError", "Konfirmasi password tidak cocok");
    return;
  }
  if (password.length < 6) {
    showError("registerError", "Password minimal 6 karakter");
    return;
  }
  
  try {
    // 1. Buat akun di Firebase Authentication
    const userCredential = await window.firebaseFunctions.createUserWithEmailAndPassword(
      window.firebaseAuth,
      email,
      password
    );
    
    const user = userCredential.user;
    
    // 2. Simpan data tambahan di Firestore
    await window.firebaseFunctions.setDoc(
      window.firebaseFunctions.doc(window.firebaseDb, "users", user.uid),
      {
        uid: user.uid,
        name: name,
        email: email,
        createdAt: new Date().toISOString(),
        referralPoints: 0,
        referrals: []
      }
    );
    
    // 3. Cek dan proses referral jika ada
    const invitedBy = localStorage.getItem("invitedBy");
    if (invitedBy) {
      try {
        // Cari user yang mengundang berdasarkan referrer ID
        const invitedByRef = window.firebaseFunctions.doc(window.firebaseDb, "users", invitedBy);
        const invitedByDoc = await window.firebaseFunctions.getDoc(invitedByRef);
        
        if (invitedByDoc.exists()) {
          // Tambahkan referral ke user yang mengundang
          await window.firebaseFunctions.updateDoc(invitedByRef, {
            referrals: window.firebaseFunctions.arrayUnion(email.split("@")[0]),
            referralPoints: window.firebaseFunctions.increment(5000) // 5000 poin per referral
          });
          
          console.log("Referral berhasil dicatat untuk:", invitedBy);
        }
      } catch (refError) {
        console.error("Error recording referral:", refError);
      }
    }
    
    // 4. Simpan info user di localStorage
    localStorage.setItem("currentUser", email);
    localStorage.setItem("userId", user.uid);
    
    alert("Pendaftaran berhasil! Anda akan diarahkan ke dashboard.");
    
    // Clear form
    document.getElementById("registerName").value = "";
    document.getElementById("registerEmail").value = "";
    document.getElementById("registerPassword").value = "";
    document.getElementById("registerConfirmPassword").value = "";
    
    // Redirect ke dashboard
    window.location.href = "dashboard.html";
    
  } catch (error) {
    console.error("Registration error:", error);
    let errorMessage = "Pendaftaran gagal";
    
    if (error.code === 'auth/email-already-in-use') {
      errorMessage = "Email sudah terdaftar";
    } else if (error.code === 'auth/invalid-email') {
      errorMessage = "Format email tidak valid";
    } else if (error.code === 'auth/weak-password') {
      errorMessage = "Password terlalu lemah. Minimal 6 karakter";
    } else if (error.code === 'auth/network-request-failed') {
      errorMessage = "Koneksi internet bermasalah. Coba lagi";
    }
    
    showError("registerError", errorMessage);
  }
});
</script>

<!-- Iklan (opsional) -->
<script type="text/javascript">
  atOptions = {
    'key' : 'b8ba39ea3ebb5f46503a0ff466df4e5f',
    'format' : 'iframe',
    'height' : 50,
    'width' : 320,
    'params' : {}
  };
</script>
<script type="text/javascript" src="//www.highperformanceformat.com/b8ba39ea3ebb5f46503a0ff466df4e5f/invoke.js"></script>

</body>
</html>
