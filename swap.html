<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Swap DAT, IDR & USDT</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
      background: linear-gradient(to right, #f0f4ff, #d9ecff);
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
    }
    .swap-box {
      background: white;
      border-radius: 16px;
      padding: 24px;
      width: 90%;
      max-width: 400px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.1);
    }
    .swap-box h2 {
      margin: 0 0 20px;
      font-size: 24px;
      text-align: center;
      color: #333;
    }
   .input-group {
  margin-bottom: 16px;
}

.label {
  font-size: 14px;
  color: #555;
  margin-bottom: 6px;
}
.input-field {
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: #f5f5f5;
  border-radius: 12px;
  padding: 12px;
}

.input-field input {
  border: none;
  background: transparent;
  font-size: 16px;
  width: 100%;
  outline: none;
  }
    .input-field input {
      border: none;
      background: transparent;
      font-size: 16px;
      width: 100%;
      outline: none;
    }
    .token-select {
      margin-left: 12px;
      font-weight: bold;
    }
    .arrow {
      text-align: center;
      margin: 16px 0;
      font-size: 24px;
    }
    .slippage {
      font-size: 12px;
      text-align: right;
      color: #888;
      margin-bottom: 12px;
    }
    .swap-button {
      width: 100%;
      background: #00c853;
      color: white;
      border: none;
      padding: 14px;
      border-radius: 12px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
    }
    .swap-button:hover {
      background: #00b34d;
    }
  </style>
</head>
<body>
  <div class="swap-box">
    <h2>Exchange</h2>

    <!-- From -->
    <div class="input-group">
      <div class="label">From</div>
      <div class="input-field">
        <input type="number" id="fromAmount" placeholder="0.0" />
        <select id="fromToken" class="token-select">
          <option value="DAT">DAT</option>
          <option value="IDR">IDR</option>
          <option value="USDT">USDT</option>
        </select>
      </div>
      <div id="fromSaldo" style="font-size: 12px; color: #666; text-align: right; margin-top: 4px;"></div>
    </div>

    <div class="arrow">↓</div>

    <!-- To -->
    <div class="input-group">
      <div class="label">To</div>
      <div class="input-field">
        <input type="number" id="toAmount" placeholder="0.0" disabled />
        <select id="toToken" class="token-select">
          <option value="IDR">IDR</option>
          <option value="DAT">DAT</option>
          <option value="USDT">USDT</option>
        </select>
      </div>
      <div id="toSaldo" style="font-size: 12px; color: #666; text-align: right; margin-top: 4px;"></div>
    </div>

    <div class="slippage">Slippage Tolerance: 0.8%</div>
  
    <div class="rate-info" style="margin: 15px 0; padding: 10px; background: #f8f9fa; border-radius: 8px; text-align: center;">
  <div>
    <strong>Kurs Saat Ini:</strong> 
    1 USDT = <span id="currentRate">15,800</span> IDR
  </div>
  <small style="color: #666;">
    Terakhir update: <span id="lastUpdate">-</span>
    <button onclick="updateExchangeRates()" style="margin-left: 10px; padding: 2px 8px; font-size: 12px; background: #e0e0e0; border: none; border-radius: 4px;">
      updated otomatis 
    </button>
  </small>
</div>
    <button class="swap-button" onclick="prosesSwap()">Swap Sekarang</button>
  </div>

  <script>
    const username = localStorage.getItem("currentUser") || "user";
    let saldo = {
      DAT: parseFloat(localStorage.getItem(username + "_totalReward") || "0"),
      IDR: parseFloat(localStorage.getItem(username + "_totalIDR") || "0"),
      USDT: parseFloat(localStorage.getItem(username + "_totalUSDT") || "0")
    };

    // Perbaikan: Gunakan nilai default yang konsisten (15,800)
    const rates = {
      "DAT_IDR": 0.5,
      "IDR_DAT": 2,
      "DAT_USDT": 0.00003,
      "USDT_DAT": 26,
      "IDR_USDT": 1 / 15800,  // Konsisten dengan 15,800
      "USDT_IDR": 15800        // Konsisten dengan UI
    };

    // Fungsi untuk update kurs
    async function updateExchangeRates() {
      try {
        const response = await fetch('https://api.exchangerate-api.com/v4/latest/USDT');
        const data = await response.json();
        
        // Perbaikan: Gunakan parameter yang benar
        const usdtToIdr = data.rates?.IDR || 15800;
        rates.USDT_IDR = usdtToIdr;
        rates.IDR_USDT = 1 / usdtToIdr;
        
        document.getElementById('currentRate').textContent = usdtToIdr.toLocaleString('id-ID');
        document.getElementById('lastUpdate').textContent = new Date().toLocaleString('id-ID');
        
        console.log('Kurs diperbarui:', rates.USDT_IDR);
      } catch (error) {
        console.error('Gagal update kurs:', error);
        rates.USDT_IDR = 15800;
        rates.IDR_USDT = 1 / 15800;
        
        // Perbaikan: Notifikasi lebih user friendly
        const notif = document.createElement('div');
        notif.textContent = 'Gagal update kurs. Menggunakan nilai default.';
        notif.style = 'position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: #ff9800; color: white; padding: 10px 20px; border-radius: 5px; z-index: 1000;';
        document.body.appendChild(notif);
        setTimeout(() => notif.remove(), 3000);
      }
    }

    // Update pertama kali saat halaman dimuat
    updateExchangeRates();

    // Auto-update setiap 5 menit
    setInterval(updateExchangeRates, 5 * 60 * 1000);

    // Perbaikan: Hapus duplikasi deklarasi variabel
    const fromAmount = document.getElementById("fromAmount");
    const toAmount = document.getElementById("toAmount");
    const fromToken = document.getElementById("fromToken");
    const toToken = document.getElementById("toToken");
    const fromSaldo = document.getElementById("fromSaldo");
    const toSaldo = document.getElementById("toSaldo");

    function updateSaldoTampilan() {
      // Perbaikan: Gunakan format
      fromSaldo.textContent = "Saldo: " + (saldo[fromToken.value] || 0).toLocaleString('en-US') + " " + fromToken.value;
      toSaldo.textContent = "Saldo: " + (saldo[toToken.value] || 0).toLocaleString('en-US') + " " + toToken.value;
    }

    function updateConversion() {
      const amount = parseFloat(fromAmount.value) || 0;
      const key = `${fromToken.value}_${toToken.value}`;
      const rate = rates[key];

      if (!rate) {
        toAmount.value = "0.0";
        return;
      }

      toAmount.value = (amount * rate).toFixed(2);
    }

    fromAmount.addEventListener("input", updateConversion);
    fromToken.addEventListener("change", () => {
      updateSaldoTampilan();
      updateConversion();
    });
    toToken.addEventListener("change", () => {
      updateSaldoTampilan();
      updateConversion();
    });
  
    function prosesSwap() {
  const amount = parseFloat(fromAmount.value);
  const from = fromToken.value;
  const to = toToken.value;
  const rateKey = `${from}_${to}`;
  const rate = rates[rateKey];

  if (!rate) {
    alert(`Konversi ${from} ke ${to} belum tersedia`);
    return;
  }

      if (!amount || amount <= 0) {
        alert("Masukkan jumlah yang valid.");
        return;
      }

      if (saldo[from] < amount) {
        alert(`❌ Saldo ${from} tidak cukup!`);
        return;
      }

      const hasil = amount * rate;

      saldo[from] -= amount;
      saldo[to] += hasil;

      localStorage.setItem(username + "_totalReward", saldo["DAT"]);
      localStorage.setItem(username + "_totalIDR", saldo["IDR"]);
      localStorage.setItem(username + "_totalUSDT", saldo["USDT"]);

      updateSaldoTampilan();
      fromAmount.value = "";
      toAmount.value = "";

      alert(`✅ Swap berhasil!\n${amount} ${from} ➝ ${hasil.toFixed(2)} ${to}`);
    }

    updateSaldoTampilan();
    updateConversion();
  </script>
  <script type='text/javascript' src='//pl27331519.profitableratecpm.com/13/4d/88/134d88f200f3571f191859bf77418cbc.js'></script>
</body>
  </html>
