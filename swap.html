<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Swap GOV, IDR & USDT</title>
   <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3665788659374137"
     crossorigin="anonymous"></script>
<!-- Gov1 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-3665788659374137"
     data-ad-slot="3774844382"
     data-ad-format="auto"
     data-full-width-responsive="true"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
	<style>
    body {
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
      background:#f1f8e9;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
    }
    .swap-box {
      background: white;
      border-radius: 16px;
      padding: 24px;
      width: 90%;
      max-width: 400px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.1);
    }
    .swap-box h2 {
      margin: 0 0 20px;
      font-size: 24px;
      text-align: center;
      color: #333;
    }
   .input-group {
  margin-bottom: 16px;
}

.label {
  font-size: 14px;
  color: #555;
  margin-bottom: 6px;
}
.input-field {
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: #f5f5f5;
  border-radius: 12px;
  padding: 12px;
}

.input-field input {
  border: none;
  background: transparent;
  font-size: 16px;
  width: 100%;
  outline: none;
  }
    .input-field input {
      border: none;
      background: transparent;
      font-size: 16px;
      width: 100%;
      outline: none;
    }
    .token-select {
      margin-left: 12px;
      font-weight: bold;
    }
    .arrow {
      text-align: center;
      margin: 16px 0;
      font-size: 24px;
    }
    .slippage {
      font-size: 12px;
      text-align: right;
      color: #888;
      margin-bottom: 12px;
    }
    .swap-button {
      width: 100%;
      background: #00c853;
      color: white;
      border: none;
      padding: 14px;
      border-radius: 12px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
    }
    .swap-button:hover {
      background: #00b34d;
    }
  </style>
</head>
<body>
  <div class="swap-box">
    <h2>Exchange</h2>
  <script type="text/javascript">
	atOptions = {
		'key' : 'b8ba39ea3ebb5f46503a0ff466df4e5f',
		'format' : 'iframe',
		'height' : 50,
		'width' : 320,
		'params' : {}
	};
</script>
<script type="text/javascript" src="//www.highperformanceformat.com/b8ba39ea3ebb5f46503a0ff466df4e5f/invoke.js"></script>
    <!-- From -->
    <div class="input-group">
      <div class="label">From</div>
      <div class="input-field">
        <input type="number" id="fromAmount" placeholder="0.0" />
        <select id="fromToken" class="token-select">
          <option value="GOV">GOV</option>
          <option value="IDR">IDR</option>
          <option value="USDT">USDT</option>
        </select>
      </div>
      <div id="fromSaldo" style="font-size: 12px; color: #666; text-align: right; margin-top: 4px;"></div>
    </div>

    <div class="arrow">‚Üì</div>

    <!-- To -->
    <div class="input-group">
      <div class="label">To</div>
      <div class="input-field">
        <input type="number" id="toAmount" placeholder="0.0" disabled />
        <select id="toToken" class="token-select">
          <option value="IDR">IDR</option>
          <option value="GOV">GOV</option>
          <option value="USDT">USDT</option>
        </select>
      </div>
      <div id="toSaldo" style="font-size: 12px; color: #666; text-align: right; margin-top: 4px;"></div>
    </div>

    <div class="slippage">Slippage Tolerance: 0.8%</div>
  
    <div class="rate-info" style="margin: 15px 0; padding: 10px; background: #f8f9fa; border-radius: 8px; text-align: center;">
  <div>
    <strong>Kurs Saat Ini:</strong> 
    1 USDT = <span id="currentRate">15,800</span> IDR
  </div>
  <small style="color: #666;">
    Terakhir update: <span id="lastUpdate">-</span>
    <button onclick="updateExchangeRates()" style="margin-left: 10px; padding: 2px 8px; font-size: 12px; background: #e0e0e0; border: none; border-radius: 4px;">
      updated otomatis 
    </button>
  </small>
</div>
    <button class="swap-button" onclick="prosesSwap()">Swap Sekarang</button>
  </div>

  <script>
    // ===== VARIABEL GLOBAL =====
    let saldo = {
      GOV: 0,
      IDR: 0,
      USDT: 0
    };
    
    // ===== FUNGSI LOAD DATA =====
    function loadData() {
        const userEmail = localStorage.getItem("currentUser");
        if (!userEmail) {
            console.log("‚ùå User belum login");
            return;
        }
        
        const username = userEmail.split("@")[0];
        
        // SUMBER 1: Dashboard Data (userData_username) - PRIORITAS UTAMA
        const dashboardKey = `userData_${username}`;
        const dashboardData = localStorage.getItem(dashboardKey);
        
        if (dashboardData) {
            try {
                const parsed = JSON.parse(dashboardData);
                saldo.GOV = parseFloat(parsed.saldoGOV) || 0;
                saldo.IDR = parseFloat(parsed.saldoIDR) || 0;
                saldo.USDT = parseFloat(parsed.saldoUSDT) || 0;
                console.log("‚úÖ Data loaded from dashboard:", saldo);
                return;
            } catch (e) {
                console.error("‚ùå Error parsing dashboard data:", e);
            }
        }
        
        // JIKA TIDAK ADA DATA
        console.log("‚ö†Ô∏è Tidak ada data yang ditemukan");
        saldo = { GOV: 0, IDR: 0, USDT: 0 };
    }

    // ===== FUNGSI SIMPAN DATA =====
    function simpanData() {
        const userEmail = localStorage.getItem("currentUser");
        if (!userEmail) {
            console.log("‚ùå Tidak bisa save: user belum login");
            return;
        }
        
        const username = userEmail.split("@")[0];
        console.log("üíæ Saving data untuk:", username, saldo);
        
        // 1. SIMPAN KE DASHBOARD DATA
        const dashboardKey = `userData_${username}`;
        let dashboardData = {};
        
        // Load existing data first
        const existingDashboardData = localStorage.getItem(dashboardKey);
        if (existingDashboardData) {
            try {
                dashboardData = JSON.parse(existingDashboardData);
            } catch (e) {
                console.error("Error parsing existing dashboard data:", e);
            }
        }
        
        // Update saldo
        dashboardData.saldoGOV = saldo.GOV;
        dashboardData.saldoIDR = saldo.IDR;
        dashboardData.saldoUSDT = saldo.USDT;
        dashboardData.lastUpdate = new Date().toISOString();
        dashboardData.email = userEmail;
        dashboardData.username = username;
        
        // Simpan ke localStorage
        localStorage.setItem(dashboardKey, JSON.stringify(dashboardData));
        console.log("‚úÖ Data saved to dashboard:", dashboardData);
        
        // 2. SIMPAN KE WALLET DATA (PENTING UNTUK WALLET.HTML)
        const walletKey = `walletData_${userEmail}`;
        let walletData = {
            saldoGOV: saldo.GOV,
            saldoIDR: saldo.IDR,
            saldoUSDT: saldo.USDT,
            lastUpdate: new Date().toISOString(),
            email: userEmail
        };
        
        // Load existing wallet transactions if any
        const existingWalletData = localStorage.getItem(walletKey);
        if (existingWalletData) {
            try {
                const parsed = JSON.parse(existingWalletData);
                if (parsed.transactions) {
                    walletData.transactions = parsed.transactions;
                }
            } catch (e) {
                console.error("Error parsing existing wallet data:", e);
            }
        }
        
        // Add current swap transaction
        const from = document.getElementById('fromToken').value;
        const to = document.getElementById('toToken').value;
        const amount = parseFloat(document.getElementById('fromAmount').value) || 0;
        const hasil = parseFloat(document.getElementById('toAmount').value) || 0;
        
        if (amount > 0) {
            const transaction = {
                type: "SWAP",
                description: `Swap ${amount} ${from} to ${hasil} ${to}`,
                from: from,
                to: to,
                amount: amount,
                received: hasil,
                timestamp: new Date().toISOString()
            };
            
            if (!walletData.transactions) walletData.transactions = [];
            walletData.transactions.unshift(transaction);
        }
        
        localStorage.setItem(walletKey, JSON.stringify(walletData));
        console.log("‚úÖ Data saved to wallet:", walletData);
        
        // 3. SIMPAN KE FIREBASE (PENTING UNTUK PERSISTENSI)
        saveToFirebase(userEmail, saldo);
    }

    // ===== FUNGSI SIMPAN KE FIREBASE =====
    function saveToFirebase(userEmail, data) {
        try {
            // Buat user ID dari email
            const userId = btoa(userEmail).replace(/[^a-zA-Z0-9]/g, '').substring(0, 20);
            
            // Data untuk Firebase
            const firebaseData = {
                balances: {
                    GOV: data.GOV,
                    IDR: data.IDR,
                    USDT: data.USDT
                },
                lastUpdate: new Date().toISOString(),
                email: userEmail,
                source: "swap_page"
            };
            
            console.log("üî• Data to save to Firebase:", firebaseData);
            
            // Simpan ke localStorage sebagai backup
            localStorage.setItem(`firebase_backup_${userId}`, JSON.stringify(firebaseData));
            console.log("‚úÖ Data backup saved to localStorage");
            
        } catch (error) {
            console.error("‚ùå Error saving to Firebase:", error);
        }
    }

    // ===== KURS EXCHANGE =====
    const rates = {
      "GOV_IDR": 0.5,
      "IDR_GOV": 2,
      "GOV_USDT": 0.00003,
      "USDT_GOV": 26,
      "IDR_USDT": 1 / 15800,
      "USDT_IDR": 15800
    };

    // Fungsi untuk update kurs
    async function updateExchangeRates() {
      try {
        const response = await fetch('https://api.exchangerate-api.com/v4/latest/USD');
        const data = await response.json();
        
        const usdToIdr = data.rates?.IDR || 15800;
        rates.USDT_IDR = usdToIdr;
        rates.IDR_USDT = 1 / usdToIdr;
        
        document.getElementById('currentRate').textContent = usdToIdr.toLocaleString('id-ID');
        document.getElementById('lastUpdate').textContent = new Date().toLocaleString('id-ID');
        
        console.log('‚úÖ Kurs diperbarui:', rates.USDT_IDR);
      } catch (error) {
        console.error('‚ùå Gagal update kurs:', error);
        rates.USDT_IDR = 15800;
        rates.IDR_USDT = 1 / 15800;
      }
    }

    // ===== ELEMEN DOM =====
    const fromAmount = document.getElementById("fromAmount");
    const toAmount = document.getElementById("toAmount");
    const fromToken = document.getElementById("fromToken");
    const toToken = document.getElementById("toToken");
    const fromSaldo = document.getElementById("fromSaldo");
    const toSaldo = document.getElementById("toSaldo");

    // ===== FUNGSI UTAMA =====
    function updateSaldoTampilan() {
      if (fromToken && toToken) {
          fromSaldo.textContent = "Saldo: " + (saldo[fromToken.value] || 0).toLocaleString('id-ID') + " " + fromToken.value;
          toSaldo.textContent = "Saldo: " + (saldo[toToken.value] || 0).toLocaleString('id-ID') + " " + toToken.value;
      }
    }

    function updateConversion() {
      const amount = parseFloat(fromAmount.value) || 0;
      const key = `${fromToken.value}_${toToken.value}`;
      const rate = rates[key];

      if (!rate) {
        toAmount.value = "0.0";
        return;
      }

      toAmount.value = (amount * rate).toFixed(2);
    }

    function prosesSwap() {
      // Validasi login
      const userEmail = localStorage.getItem("currentUser");
      if (!userEmail) {
          alert("‚ùå Anda harus login terlebih dahulu!");
          setTimeout(() => window.location.href = "index.html", 1000);
          return;
      }
      
      const amount = parseFloat(fromAmount.value);
      const from = fromToken.value;
      const to = toToken.value;
      const rateKey = `${from}_${to}`;
      const rate = rates[rateKey];

      if (!rate) {
        alert(`‚ùå Konversi ${from} ke ${to} belum tersedia`);
        return;
      }

      if (!amount || amount <= 0) {
        alert("‚ùå Masukkan jumlah yang valid.");
        return;
      }

      if (saldo[from] < amount) {
        alert(`‚ùå Saldo ${from} tidak cukup!\nSaldo Anda: ${saldo[from].toLocaleString('id-ID')} ${from}`);
        return;
      }

      const hasil = amount * rate;

      // Update saldo lokal
      saldo[from] -= amount;
      saldo[to] += hasil;

      // Simpan ke SEMUA tempat
      simpanData();

      // Update tampilan
      updateSaldoTampilan();
      fromAmount.value = "";
      toAmount.value = "";

      // Tampilkan notifikasi
      showNotification(`‚úÖ Swap berhasil!\n${amount.toLocaleString('id-ID')} ${from} ‚Üí ${hasil.toFixed(2).toLocaleString('id-ID')} ${to}`, true);
      
      console.log("üîÑ Swap completed:", {
          from, to, amount, hasil,
          newBalances: saldo,
          user: userEmail
      });
    }

    // ===== FUNGSI NOTIFIKASI =====
    function showNotification(message, isSuccess = true) {
      const notification = document.createElement('div');
      notification.textContent = message;
      notification.style = `position: fixed; top: 20px; left: 50%; transform: translateX(-50%); 
                            background: ${isSuccess ? '#4CAF50' : '#f44336'}; color: white; 
                            padding: 12px 24px; border-radius: 8px; z-index: 1000; 
                            font-weight: bold; box-shadow: 0 4px 12px rgba(0,0,0,0.15);`;
      document.body.appendChild(notification);
      setTimeout(() => notification.remove(), 3000);
    }

    // ===== INISIALISASI =====
    document.addEventListener("DOMContentLoaded", function() {
      console.log("üîÑ Swap page initializing...");
      
      // Cek login
      const userEmail = localStorage.getItem('currentUser');
      if (!userEmail) {
          showNotification("‚ö†Ô∏è Anda harus login terlebih dahulu!", false);
          setTimeout(() => window.location.href = "index.html", 1500);
          return;
      }
      
      // Load data
      loadData();
      
      // Update kurs
      updateExchangeRates();
      
      // Update tampilan saldo
      updateSaldoTampilan();
      
      // Setup event listeners
      if (fromAmount && fromToken && toToken) {
          fromAmount.addEventListener("input", updateConversion);
          fromToken.addEventListener("change", () => {
              updateSaldoTampilan();
              updateConversion();
          });
          toToken.addEventListener("change", () => {
              updateSaldoTampilan();
              updateConversion();
          });
      }
      
      console.log("‚úÖ Swap page initialized");
      console.log("üìä Current balances:", saldo);
    });
  </script>
  <script type='text/javascript' src='//pl27331519.profitableratecpm.com/13/4d/88/134d88f200f3571f191859bf77418cbc.js'></script>
</body>
</html>
