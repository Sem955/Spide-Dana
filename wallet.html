<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dompet Saya</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: Arial; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 500px; margin: auto; background: white; border-radius: 20px; padding: 30px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
        h1 { text-align: center; color: #333; margin-bottom: 10px; }
        .subtitle { text-align: center; color: #666; margin-bottom: 30px; }
        .status { padding: 10px; border-radius: 10px; margin: 20px 0; text-align: center; font-weight: bold; }
        .online { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .offline { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .wallet-card { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 25px; border-radius: 15px; margin: 25px 0; }
        .balance { display: flex; justify-content: space-between; margin: 15px 0; font-size: 18px; padding: 10px 0; border-bottom: 1px solid rgba(255,255,255,0.2); }
        .balance:last-child { border-bottom: none; }
        button { width: 100%; padding: 16px; margin: 10px 0; border: none; border-radius: 12px; font-size: 16px; font-weight: bold; cursor: pointer; transition: transform 0.2s; }
        button:hover { transform: translateY(-2px); }
        .btn-primary { background: #1890ff; color: white; }
        .btn-success { background: #52c41a; color: white; }
        .btn-warning { background: #faad14; color: white; }
        .btn-danger { background: #ff4d4f; color: white; }
        .sync-indicator { position: fixed; top: 20px; right: 20px; background: #1890ff; color: white; padding: 8px 16px; border-radius: 20px; font-size: 14px; display: none; z-index: 1000; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }
        .user-info { text-align: center; padding: 15px; background: #f8f9fa; border-radius: 10px; margin: 15px 0; }
        .transaction { background: #f8f9fa; padding: 10px; border-radius: 8px; margin: 5px 0; border-left: 4px solid #1890ff; }
    </style>
</head>
<body>

<div class="sync-indicator" id="syncIndicator"></div>

<div class="container">
    <h1>üí∞ Dompet Saya</h1>
    <div class="subtitle" id="subtitle">Saldo Sync Otomatis Antar HP</div>
    
    <!-- Connection Status -->
    <div id="connectionStatus" class="status offline">üî¥ Menghubungkan...</div>
    
    <!-- User Info -->
    <div class="user-info" id="userInfo">
        <div id="userEmail">Belum login</div>
        <div id="userUID" style="font-size: 12px; color: #666; margin-top: 5px;"></div>
    </div>
    
    <!-- Wallet Card -->
    <div class="wallet-card">
        <h2 style="text-align: center; margin-bottom: 20px;">Saldo Anda</h2>
        <div class="balance">
            <span>GOV Coin</span>
            <span id="saldoGOV">0 GOV</span>
        </div>
        <div class="balance">
            <span>Rupiah (IDR)</span>
            <span id="saldoIDR">Rp 0</span>
        </div>
        <div class="balance">
            <span>USDT</span>
            <span id="saldoUSDT">0.00 USDT</span>
        </div>
        <div style="text-align: center; margin-top: 15px; font-size: 14px; opacity: 0.9;">
            Terakhir update: <span id="lastUpdate">-</span>
        </div>
    </div>
    
    <!-- Quick Actions -->
    <button class="btn-success" onclick="syncFromDashboard()">üîÑ Sync dari Dashboard</button>
    <button class="btn-primary" onclick="addGOV(100)">‚ûï Tambah 100 GOV (Test)</button>
    
    <!-- Transaction History -->
    <h3 style="margin-top: 30px; color: #333;">üìã Riwayat Transaksi</h3>
    <div id="transactionHistory" style="margin-top: 10px;">
        <div class="transaction">Tunggu data...</div>
    </div>
    
    <!-- Action Buttons -->
    <button class="btn-warning" onclick="exportData()">üì§ Export Data</button>
    <button class="btn-danger" onclick="resetData()">üîÑ Reset Data</button>
    <button class="btn-primary" onclick="window.location.href='dashboard.html'">‚Üê Kembali ke Dashboard</button>
    
    <!-- Debug Info -->
    <div style="margin-top: 30px; padding: 15px; background: #f8f9fa; border-radius: 10px; font-size: 13px;">
        <strong>üìä Status Sistem:</strong>
        <div id="debugInfo" style="margin-top: 10px;"></div>
    </div>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script>
// ===== FIREBASE CONFIG =====
const firebaseConfig = {
    apiKey: "AIzaSyAlXIQ42acjO8xZH-Ti__YL6h9SGQQKQto",
    authDomain: "govminer.firebasestorage.app",
    databaseURL: "https://govminer-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "govminer",
    storageBucket: "govminer.firebasestorage.app",
    messagingSenderId: "408110658500",
    appId: "1:408110658500:web:3fe7f4bd9a35f3fe726a91"
};

// ===== GLOBAL VARIABLES =====
let auth = null;
let database = null;
let currentUser = null;
let walletData = {
    saldoGOV: 0,
    saldoIDR: 0,
    saldoUSDT: 0,
    transactions: [],
    lastSync: null
};

// ===== INITIALIZE =====
async function initializeApp() {
    try {
        // Initialize Firebase with Realtime Database
        firebase.initializeApp(firebaseConfig);
        auth = firebase.auth();
        database = firebase.database();
        
        updateDebugInfo("‚úÖ Firebase Realtime Database initialized");
        updateConnectionStatus("üü¢ Terhubung ke Server");
        
        // Setup auth listener
        auth.onAuthStateChanged(handleAuthStateChange);
        
        // Check localStorage for user
        const savedUser = localStorage.getItem('currentUser');
        if (savedUser) {
            try {
                const userData = JSON.parse(savedUser);
                document.getElementById('subtitle').textContent = `User: ${userData.email}`;
                
                // Try auto-login
                if (!auth.currentUser) {
                    await auth.signInWithEmailAndPassword(userData.email, userData.password || "password123");
                }
            } catch (e) {
                updateDebugInfo("Auto-login failed: " + e.message);
            }
        }
        
        // Setup real-time listener
        setupRealtimeListener();
        
    } catch (error) {
        console.error("Initialization error:", error);
        updateConnectionStatus("üî¥ Error: " + error.message);
        loadFromLocalStorage();
    }
}

// ===== AUTH HANDLER =====
function handleAuthStateChange(user) {
    if (user) {
        // User is signed in
        currentUser = user;
        
        document.getElementById('userEmail').textContent = `üë§ ${user.email}`;
        document.getElementById('userUID').textContent = `UID: ${user.uid.substring(0, 12)}...`;
        
        updateDebugInfo(`‚úÖ User authenticated: ${user.email}`);
        
        // Save user info to localStorage
        localStorage.setItem('currentUser', JSON.stringify({
            email: user.email,
            uid: user.uid,
            lastLogin: new Date().toISOString()
        }));
        
        // Load wallet data from server
        loadWalletData();
        
    } else {
        // User is signed out
        currentUser = null;
        document.getElementById('userEmail').textContent = "Belum login";
        document.getElementById('userUID').textContent = "";
        
        // Load from localStorage for guest mode
        loadFromLocalStorage();
    }
}

// ===== LOAD WALLET DATA =====
async function loadWalletData() {
    if (!currentUser) {
        loadFromLocalStorage();
        return;
    }
    
    showSyncIndicator("Memuat data dari server...");
    
    try {
        const walletRef = database.ref(`wallets/${currentUser.uid}`);
        const snapshot = await walletRef.once('value');
        
        if (snapshot.exists()) {
            // Data exists on server
            const serverData = snapshot.val();
            walletData = {
                saldoGOV: serverData.saldoGOV || 0,
                saldoIDR: serverData.saldoIDR || 0,
                saldoUSDT: serverData.saldoUSDT || 0,
                transactions: serverData.transactions || [],
                lastSync: serverData.lastSync || new Date().toISOString()
            };
            
            updateDebugInfo(`‚úÖ Data loaded from server`);
            
        } else {
            // No data on server, try to get from dashboard data
            await syncFromDashboard();
        }
        
        updateDisplay();
        saveToLocalStorage();
        
    } catch (error) {
        console.error("Load error:", error);
        updateDebugInfo("‚ùå Server load failed, using local data");
        loadFromLocalStorage();
    }
    
    hideSyncIndicator();
}

// ===== SYNC FROM DASHBOARD =====
async function syncFromDashboard() {
    if (!currentUser) {
        alert("Silakan login dulu");
        return;
    }
    
    showSyncIndicator("Menyinkronkan dari Dashboard...");
    
    try {
        // Get dashboard data from localStorage
        const dashboardData = getDashboardData();
        
        if (dashboardData) {
            // Merge with existing wallet data
            walletData.saldoGOV = dashboardData.saldoGOV || walletData.saldoGOV;
            walletData.saldoIDR = dashboardData.saldoIDR || walletData.saldoIDR;
            walletData.saldoUSDT = dashboardData.saldoUSDT || walletData.saldoUSDT;
            
            // Add transaction record
            addTransaction("SYNC", "Sync dari Dashboard", dashboardData.saldoGOV || 0);
            
            updateDebugInfo(`‚úÖ Sync berhasil dari Dashboard`);
            
        } else {
            // Get from dashboard localStorage
            const userEmail = localStorage.getItem('currentUser');
            if (userEmail) {
                const username = userEmail.split('@')[0];
                const savedData = localStorage.getItem(`userData_${username}`);
                
                if (savedData) {
                    const parsedData = JSON.parse(savedData);
                    
                    walletData.saldoGOV = parsedData.saldoGOV || walletData.saldoGOV;
                    walletData.referralPoints = parsedData.referralPoints || 0;
                    
                    addTransaction("SYNC", "Sync dari localStorage", parsedData.saldoGOV || 0);
                    
                    updateDebugInfo(`‚úÖ Sync berhasil dari localStorage`);
                }
            }
        }
        
        // Save to server
        await saveWalletData();
        
        alert("‚úÖ Sync berhasil!\n\nSaldo dari dashboard sudah ditambahkan ke dompet.");
        
    } catch (error) {
        console.error("Sync error:", error);
        alert("‚ùå Sync gagal: " + error.message);
    }
    
    hideSyncIndicator();
}

// ===== GET DASHBOARD DATA =====
function getDashboardData() {
    try {
        // Try to get from dashboard's localStorage data
        const userEmail = localStorage.getItem('currentUser');
        if (!userEmail) return null;
        
        const username = userEmail.split('@')[0];
        const dashboardKey = `userData_${username}`;
        const savedData = localStorage.getItem(dashboardKey);
        
        if (savedData) {
            const data = JSON.parse(savedData);
            
            return {
                saldoGOV: data.saldoGOV || 0,
                referralPoints: data.referralPoints || 0,
                lastClaimTime: data.lastClaimTime || null
            };
        }
        
        return null;
        
    } catch (error) {
        console.error("Get dashboard data error:", error);
        return null;
    }
}

// ===== SAVE WALLET DATA =====
async function saveWalletData() {
    if (!currentUser) {
        // Save to localStorage only
        saveToLocalStorage();
        return false;
    }
    
    showSyncIndicator("Menyimpan ke server...");
    
    try {
        const walletRef = database.ref(`wallets/${currentUser.uid}`);
        
        const dataToSave = {
            ...walletData,
            email: currentUser.email,
            lastUpdate: new Date().toISOString(),
            device: navigator.userAgent.substring(0, 100)
        };
        
        await walletRef.set(dataToSave);
        
        // Also save to localStorage
        saveToLocalStorage();
        
        updateDebugInfo(`‚úÖ Data saved to server: ${new Date().toLocaleTimeString()}`);
        hideSyncIndicator();
        return true;
        
    } catch (error) {
        console.error("Save error:", error);
        updateDebugInfo("‚ùå Server save failed, saved locally");
        
        // Save to localStorage as fallback
        saveToLocalStorage();
        hideSyncIndicator();
        return false;
    }
}

// ===== LOCAL STORAGE FUNCTIONS =====
function saveToLocalStorage() {
    try {
        const dataToSave = {
            ...walletData,
            savedAt: new Date().toISOString(),
            user: currentUser ? currentUser.email : 'guest'
        };
        
        localStorage.setItem('walletData', JSON.stringify(dataToSave));
        
    } catch (error) {
        console.error("LocalStorage save error:", error);
    }
}

function loadFromLocalStorage() {
    try {
        const savedData = localStorage.getItem('walletData');
        if (savedData) {
            const parsedData = JSON.parse(savedData);
            walletData = {
                saldoGOV: parsedData.saldoGOV || 0,
                saldoIDR: parsedData.saldoIDR || 0,
                saldoUSDT: parsedData.saldoUSDT || 0,
                transactions: parsedData.transactions || [],
                lastSync: parsedData.lastSync || null
            };
            
            updateDebugInfo("üìÇ Data loaded from localStorage");
            updateDisplay();
            return true;
        }
    } catch (error) {
        console.error("LocalStorage load error:", error);
    }
    
    // Default data
    walletData = {
        saldoGOV: 1000,
        saldoIDR: 50000,
        saldoUSDT: 5.5,
        transactions: [
            { type: "SYSTEM", description: "Saldo awal", amount: 1000, timestamp: new Date().toISOString() }
        ],
        lastSync: null
    };
    
    updateDisplay();
    return false;
}

// ===== TRANSACTION FUNCTIONS =====
function addTransaction(type, description, amount) {
    const transaction = {
        type: type,
        description: description,
        amount: amount,
        timestamp: new Date().toISOString()
    };
    
    walletData.transactions.unshift(transaction);
    
    // Keep only last 20 transactions
    if (walletData.transactions.length > 20) {
        walletData.transactions = walletData.transactions.slice(0, 20);
    }
    
    updateTransactionHistory();
}

function updateTransactionHistory() {
    const container = document.getElementById('transactionHistory');
    
    if (!walletData.transactions || walletData.transactions.length === 0) {
        container.innerHTML = '<div class="transaction">Belum ada transaksi</div>';
        return;
    }
    
    const transactionsHTML = walletData.transactions.map(t => {
        const date = new Date(t.timestamp).toLocaleString();
        const amount = t.amount > 0 ? `+${t.amount}` : t.amount;
        const color = t.amount > 0 ? 'green' : 'red';
        
        return `
            <div class="transaction">
                <div style="display: flex; justify-content: space-between;">
                    <strong>${t.description}</strong>
                    <span style="color: ${color}; font-weight: bold;">${amount} GOV</span>
                </div>
                <div style="font-size: 12px; color: #666; margin-top: 5px;">
                    ${date} ‚Ä¢ ${t.type}
                </div>
            </div>
        `;
    }).join('');
    
    container.innerHTML = transactionsHTML;
}

// ===== DISPLAY FUNCTIONS =====
function updateDisplay() {
    document.getElementById('saldoGOV').textContent = 
        walletData.saldoGOV.toLocaleString('id-ID') + ' GOV';
    document.getElementById('saldoIDR').textContent = 
        'Rp ' + walletData.saldoIDR.toLocaleString('id-ID');
    document.getElementById('saldoUSDT').textContent = 
        walletData.saldoUSDT.toFixed(2) + ' USDT';
    
    document.getElementById('lastUpdate').textContent = 
        walletData.lastSync ? new Date(walletData.lastSync).toLocaleString() : 'Belum pernah';
    
    updateTransactionHistory();
}

// ===== ACTION FUNCTIONS =====
async function addGOV(amount) {
    if (!currentUser) {
        alert("Silakan login dulu untuk menambah saldo");
        return;
    }
    
    walletData.saldoGOV += amount;
    
    addTransaction("MANUAL", "Tambah saldo manual", amount);
    
    const saved = await saveWalletData();
    
    if (saved) {
        alert(`‚úÖ Berhasil tambah ${amount} GOV!\n\nSaldo baru: ${walletData.saldoGOV.toLocaleString('id-ID')} GOV\n\n‚úÖ Data sudah disimpan di server untuk semua HP.`);
    } else {
        alert(`‚ö†Ô∏è ${amount} GOV ditambahkan (hanya lokal)\n\nSaldo baru: ${walletData.saldoGOV.toLocaleString('id-ID')} GOV`);
    }
    
    updateDisplay();
}

function exportData() {
    const exportData = {
        ...walletData,
        exportVersion: '1.0',
        exportDate: new Date().toISOString(),
        exportDevice: navigator.userAgent
    };
    
    const dataStr = JSON.stringify(exportData, null, 2);
    const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);
    
    const exportName = `wallet-backup-${new Date().toISOString().slice(0,10)}.json`;
    
    const link = document.createElement('a');
    link.setAttribute('href', dataUri);
    link.setAttribute('download', exportName);
    link.click();
    
    alert(`‚úÖ Data berhasil diexport!\n\nFile: ${exportName}\n\nSimpan untuk backup.`);
}

function resetData() {
    if (!confirm("Yakin reset semua data dompet?\nIni tidak bisa dibatalkan!")) return;
    
    walletData = {
        saldoGOV: 0,
        saldoIDR: 0,
        saldoUSDT: 0,
        transactions: [],
        lastSync: new Date().toISOString()
    };
    
    if (currentUser && database) {
        saveWalletData();
    } else {
        saveToLocalStorage();
    }
    
    updateDisplay();
    alert("‚úÖ Data dompet direset ke 0");
}

// ===== REALTIME LISTENER =====
function setupRealtimeListener() {
    if (!currentUser || !database) return;
    
    const walletRef = database.ref(`wallets/${currentUser.uid}`);
    
    walletRef.on('value', (snapshot) => {
        if (snapshot.exists()) {
            const serverData = snapshot.val();
            
            // Check if data is different
            if (JSON.stringify(walletData) !== JSON.stringify(serverData)) {
                walletData = serverData;
                updateDisplay();
                updateDebugInfo(`üîÑ Real-time update: ${new Date().toLocaleTimeString()}`);
            }
        }
    });
}

// ===== UTILITY FUNCTIONS =====
function updateConnectionStatus(text) {
    const statusEl = document.getElementById('connectionStatus');
    statusEl.textContent = text;
    
    if (text.includes('üü¢') || text.includes('Terhubung')) {
        statusEl.className = 'status online';
    } else {
        statusEl.className = 'status offline';
    }
}

function updateDebugInfo(text) {
    document.getElementById('debugInfo').innerHTML = text;
    console.log('[Wallet]', text);
}

function showSyncIndicator(text) {
    const indicator = document.getElementById('syncIndicator');
    indicator.textContent = text;
    indicator.style.display = 'block';
}

function hideSyncIndicator() {
    const indicator = document.getElementById('syncIndicator');
    indicator.style.display = 'none';
}

// ===== INITIALIZE =====
document.addEventListener('DOMContentLoaded', initializeApp);

// Auto-save every 30 seconds
setInterval(() => {
    if (currentUser) {
        saveWalletData();
    }
}, 30000);
</script>

</body>
</html>
