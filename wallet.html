<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dompet Saya</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: white;
        }
        
        .container { 
            max-width: 500px; 
            margin: auto; 
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px; 
            padding: 25px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        /* Header */
        .header {
            text-align: center;
            margin-bottom: 25px;
        }
        
        .header h1 { 
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 5px;
            color: white;
        }
        
        .header .subtitle { 
            color: rgba(255, 255, 255, 0.8); 
            font-size: 14px; 
            margin-bottom: 10px;
        }
        
        /* Modern Wallet Card */
        .wallet-card-modern {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.15), rgba(255, 255, 255, 0.1));
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.2);
            position: relative;
            overflow: hidden;
        }
        
        .wallet-card-modern::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200px;
            height: 200px;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            border-radius: 50%;
        }
        
        .balance-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .balance-row:last-child {
            border-bottom: none;
        }
        
        .balance-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .balance-icon {
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }
        
        .balance-text {
            display: flex;
            flex-direction: column;
        }
        
        .balance-label {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 4px;
        }
        
        .balance-amount {
            font-size: 20px;
            font-weight: 700;
            color: white;
        }
        
        .balance-currency {
            font-size: 14px;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.9);
        }
        
        /* Action Buttons Horizontal */
        .action-buttons-horizontal {
            display: flex;
            gap: 12px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }
        
        .action-btn-horizontal {
            flex: 1;
            min-width: 120px;
            background: rgba(255, 255, 255, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            padding: 15px;
            text-align: center;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .action-btn-horizontal:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateY(-2px);
        }
        
        .action-btn-icon {
            font-size: 24px;
            margin-bottom: 8px;
        }
        
        .action-btn-text {
            font-size: 12px;
            font-weight: 600;
        }
        
        /* Sync Button */
        .sync-btn-container {
            display: flex;
            gap: 12px;
            margin-bottom: 25px;
        }
        
        .sync-btn {
            flex: 1;
            background: rgba(255, 255, 255, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            padding: 15px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .sync-btn:hover {
            background: rgba(255, 255, 255, 0.25);
        }
        
        /* Hidden Sections */
        .hidden-section {
            display: none;
        }
        
        /* Modal Styles */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }
        
        .modal-content {
            background: white;
            width: 90%;
            max-width: 400px;
            border-radius: 20px;
            padding: 24px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
        }
        
        .form-group {
            width: 100%;
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            color: #555;
            font-weight: 600;
        }
        
        .form-group input, .form-group select {
            width: 100%;
            padding: 14px;
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            font-size: 14px;
            box-sizing: border-box;
            transition: border-color 0.3s;
        }
        
        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .button-group {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }
        
        .submit-btn { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; 
            flex: 1; 
            border: none;
            border-radius: 12px;
            padding: 14px;
            font-weight: 600;
            cursor: pointer;
        }
        
        .cancel-btn { 
            background: #f5f5f5; 
            color: #333; 
            flex: 1; 
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            padding: 14px;
            font-weight: 600;
            cursor: pointer;
        }
        
        /* Notification */
        #notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #4caf50;
            color: white;
            padding: 14px 24px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            z-index: 2000;
            display: none;
            animation: fadeInOut 4s ease-in-out forwards;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        @keyframes fadeInOut {
            0% { opacity: 0; transform: translate(-50%, -20px); }
            10%, 90% { opacity: 1; transform: translate(-50%, 0); }
            100% { opacity: 0; transform: translate(-50%, -20px); }
        }
        
        /* Last Update */
        .last-update {
            text-align: center;
            color: rgba(255, 255, 255, 0.7);
            font-size: 12px;
            margin-top: 15px;
        }
    </style>
</head>
<body>

<div id="notification"></div>

<div class="container">
    <!-- Header -->
    <div class="header">
        <h1>üí∞ Dompet Saya</h1>
        <div class="subtitle" id="subtitle">Saldo Sinkron dengan Dashboard</div>
    </div>
    
    <!-- Modern Wallet Card -->
    <div class="wallet-card-modern">
        <div class="balance-row">
            <div class="balance-info">
                <div class="balance-icon">‚Çø</div>
                <div class="balance-text">
                    <div class="balance-label">Saldo GOV</div>
                    <div class="balance-amount" id="saldoGOV">0</div>
                </div>
            </div>
            <div class="balance-currency">GOV</div>
        </div>
        
        <div class="balance-row">
            <div class="balance-info">
                <div class="balance-icon">Rp</div>
                <div class="balance-text">
                    <div class="balance-label">Saldo IDR</div>
                    <div class="balance-amount" id="saldoIDR">0</div>
                </div>
            </div>
            <div class="balance-currency">IDR</div>
        </div>
        
        <div class="balance-row">
            <div class="balance-info">
                <div class="balance-icon">$</div>
                <div class="balance-text">
                    <div class="balance-label">Saldo USDT</div>
                    <div class="balance-amount" id="saldoUSDT">0.00</div>
                </div>
            </div>
            <div class="balance-currency">USDT</div>
        </div>
        
        <div class="last-update">
            <span id="lastUpdate">Data lokal</span>
        </div>
    </div>
    
    <!-- Action Buttons Horizontal -->
    <div class="action-buttons-horizontal">
        <div class="action-btn-horizontal" onclick="showWithdrawModal()">
            <div class="action-btn-icon">üí∏</div>
            <div class="action-btn-text">Withdraw</div>
        </div>
        <div class="action-btn-horizontal" onclick="showTransferModal()">
            <div class="action-btn-icon">üì§</div>
            <div class="action-btn-text">Transfer GOV</div>
        </div>
        <div class="action-btn-horizontal" onclick="window.location.href='dashboard.html'">
            <div class="action-btn-icon">‚Üê</div>
            <div class="action-btn-text">Kembali ke Dashboard</div>
        </div>
        <div class="action-btn-horizontal" onclick="showTransactionHistory()">
            <div class="action-btn-icon">üìã</div>
            <div class="action-btn-text">Riwayat</div>
        </div>
    </div>
    
    <!-- Sync Buttons -->
    <div class="sync-btn-container">
        <div class="sync-btn" onclick="forceSyncFromDashboard()">
            üì• Tarik dari Dashboard
        </div>
        <div class="sync-btn" onclick="syncWithDashboard()">
            üîÑ Sync dengan Dashboard
        </div>
        <div class="sync-btn" onclick="forceSyncToDashboard()">
            üì§ Push ke Dashboard
        </div>
    </div>
    
    <!-- Hidden Original Content -->
    <div class="hidden-section">
        <!-- Semua konten asli tetap ada tapi tersembunyi -->
        <div class="status-box">
            <h3 style="margin-top: 0; color: #856404;">üìä Status Sistem</h3>
            <div class="status-item">
                <span class="status-label">Status:</span>
                <span class="status-value" id="statusServer">Loading...</span>
            </div>
            <div class="status-item">
                <span class="status-label">User:</span>
                <span class="status-value" id="statusUser">Loading...</span>
            </div>
            <div class="status-item">
                <span class="status-label">Dashboard Sync:</span>
                <span class="status-value" id="statusSync">Checking...</span>
            </div>
        </div>
        
        <!-- Transaction History -->
        <div class="transfer-section">
            <h3>üìã Riwayat Transaksi</h3>
            <div id="transactionHistory">
                <div style="text-align: center; color: #666; padding: 20px;">
                    Memuat transaksi...
                </div>
            </div>
        </div>
    </div>
    
    <div class="footer">¬© 2025 Dompet Digital</div>
</div>

<!-- Modals (tetap sama) -->
<!-- Withdraw Modal -->
<div id="withdrawModal" class="modal-overlay">
    <div class="modal-content">
        <h3 style="margin-top: 0; color: #333;">üí∏ Withdraw Saldo</h3>
        
        <div class="form-group">
            <label>Pilih Jenis Saldo</label>
            <select id="withdrawType" onchange="updateWithdrawInfo()">
                <option value="IDR">Rupiah (IDR)</option>
                <option value="USDT">USDT</option>
                <option value="GOV">GOV Coin</option>
            </select>
        </div>
        
        <div class="form-group">
            <label>Jumlah <span id="minWithdrawText">(Minimal 200,000 IDR)</span></label>
            <input type="number" id="withdrawAmount" placeholder="Masukkan jumlah">
        </div>
        
        <div class="form-group">
            <label>Nomor DANA/OVO/GoPay</label>
            <input type="text" id="withdrawAccount" placeholder="Contoh: 081234567890">
        </div>
        
        <div class="form-group">
            <label>Email Anda (untuk konfirmasi)</label>
            <input type="email" id="withdrawEmail" placeholder="email@anda.com">
        </div>
        
        <div style="background: #f0f4ff; padding: 15px; border-radius: 12px; margin: 20px 0; border: 1px solid #e0e0e0;">
            <strong style="color: #333;">Info:</strong>
            <div id="withdrawInfo" style="color: #666; margin-top: 8px; font-size: 14px;">
                Withdraw diproses 1x24 jam. Minimal penarikan 200,000 IDR.
            </div>
        </div>
        
        <div class="button-group">
            <button class="submit-btn" onclick="processWithdraw()">‚úÖ Submit Withdraw</button>
            <button class="cancel-btn" onclick="hideWithdrawModal()">‚ùå Batal</button>
        </div>
    </div>
</div>

<!-- Deposit Modal (hidden but functional) -->
<div id="depositModal" class="modal-overlay">
    <div class="modal-content">
        <h3 style="margin-top: 0; color: #333;">üí∞ Deposit/Topup</h3>
        
        <div class="form-group">
            <label>Pilih Jenis Saldo</label>
            <select id="depositType">
                <option value="IDR">Rupiah (IDR)</option>
                <option value="USDT">USDT</option>
                <option value="GOV">GOV Coin</option>
            </select>
        </div>
        
        <div class="form-group">
            <label>Jumlah Deposit</label>
            <input type="number" id="depositAmount" placeholder="Masukkan jumlah">
        </div>
        
        <div class="form-group">
            <label>Metode Pembayaran</label>
            <select id="depositMethod">
                <option value="DANA">DANA</option>
                <option value="OVO">OVO</option>
                <option value="GoPay">GoPay</option>
                <option value="Bank">Transfer Bank</option>
                <option value="Crypto">Crypto (USDT)</option>
            </select>
        </div>
        
        <div style="background: #f0f4ff; padding: 15px; border-radius: 12px; margin: 20px 0; border: 1px solid #e0e0e0;">
            <strong style="color: #333;">Instruksi:</strong>
            <div id="depositInstruction" style="color: #666; margin-top: 8px; font-size: 14px;">
                Transfer ke: 081234567890 (DANA)<br>
                Atas nama: Admin GovMiner<br>
                Kode: <strong id="depositCode">GOV-12345</strong>
            </div>
        </div>
        
        <div class="button-group">
            <button class="submit-btn" onclick="processDeposit()">üí≥ Bayar Sekarang</button>
            <button class="cancel-btn" onclick="hideDepositModal()">‚ùå Batal</button>
        </div>
    </div>
</div>

<!-- Transfer Modal -->
<div id="transferModal" class="modal-overlay">
    <div class="modal-content">
        <h3 style="margin-top: 0; color: #333;">üì§ Transfer GOV</h3>
        
        <div class="form-group">
            <label>Email Penerima</label>
            <input type="email" id="transferEmail" placeholder="user@email.com">
        </div>
        
        <div class="form-group">
            <label>Jumlah GOV</label>
            <input type="number" id="transferAmount" placeholder="Masukkan jumlah">
        </div>
        
        <div class="form-group">
            <label>Pesan (Opsional)</label>
            <input type="text" id="transferMessage" placeholder="Ucapan selamat atau catatan">
        </div>
        
        <div style="background: #f0f4ff; padding: 15px; border-radius: 12px; margin: 20px 0; border: 1px solid #e0e0e0;">
            <strong style="color: #333;">Info:</strong><br>
            <span style="color: #666; font-size: 14px;">
                <strong>Biaya:</strong> Gratis (0% fee)<br>
                <strong>Estimasi:</strong> Langsung sampai
            </span>
        </div>
        
        <div class="button-group">
            <button class="submit-btn" onclick="processTransfer()">üöÄ Kirim Sekarang</button>
            <button class="cancel-btn" onclick="hideTransferModal()">‚ùå Batal</button>
        </div>
    </div>
</div>

<script>
// ===== TELEGRAM CONFIG =====
const telegramToken = '8302323286:AAEM6xferO3kn5Bfx9Gc1tNu2iGeDEhXdr4';
const telegramChatId = '5788541286';

// ===== GLOBAL VARIABLES =====
let walletData = {
    saldoGOV: 0,
    saldoIDR: 0,
    saldoUSDT: 0,
    transactions: [],
    withdrawHistory: [],
    lastSync: null,
    dashboardSync: false
};

// ===== INITIALIZE =====
function initializeApp() {
    console.log("üöÄ Initializing Wallet App...");
    
    // Load user info
    const userEmail = localStorage.getItem('currentUser');
    if (userEmail) {
        document.getElementById('subtitle').textContent = `User: ${userEmail}`;
    } else {
        document.getElementById('subtitle').textContent = 'Guest Mode';
    }
    
    // Load wallet data
    loadWalletData();
    
    // Check sync with dashboard
    checkDashboardSync();
}

// ===== LOAD WALLET DATA =====
function loadWalletData() {
    console.log("üìÇ Loading wallet data...");
    
    const userEmail = localStorage.getItem('currentUser');
    if (!userEmail) {
        console.log("No user logged in");
        updateDisplay();
        return;
    }
    
    try {
        const walletKey = `walletData_${userEmail}`;
        const savedData = localStorage.getItem(walletKey);
        
        if (savedData) {
            walletData = JSON.parse(savedData);
            console.log("‚úÖ Wallet data loaded:", walletData.saldoGOV, "GOV");
            
            // Check if this is new user from dashboard
            checkForNewUserBonus();
            
        } else {
            // Coba load dari dashboard data
            loadFromDashboard();
        }
        
        updateDisplay();
        
    } catch (error) {
        console.error("‚ùå Error loading wallet:", error);
        showNotification("‚ùå Gagal memuat data wallet", false);
    }
}

// ===== CHECK FOR NEW USER BONUS =====
function checkForNewUserBonus() {
    const userEmail = localStorage.getItem('currentUser');
    if (!userEmail) return;
    
    const username = userEmail.split('@')[0];
    const dashboardKey = `userData_${username}`;
    const savedData = localStorage.getItem(dashboardKey);
    
    if (savedData) {
        const dashboardData = JSON.parse(savedData);
        
        // Jika dashboard punya 100 GOV dan wallet 0, berarti user baru
        if (dashboardData.saldoGOV === 100 && walletData.saldoGOV === 0) {
            console.log("üÜï New user detected, syncing 100 GOV from dashboard");
            walletData.saldoGOV = 100;
            
            // Add transaction
            addTransaction('BONUS', 'Bonus pendaftaran baru', 100);
            
            // Save wallet
            saveWalletData();
            updateDisplay();
            
            showNotification("üéâ Bonus 100 GOV berhasil disinkronkan!");
        }
    }
}

// ===== LOAD FROM DASHBOARD =====
function loadFromDashboard() {
    const userEmail = localStorage.getItem('currentUser');
    if (!userEmail) return;
    
    const username = userEmail.split('@')[0];
    const dashboardKey = `userData_${username}`;
    const savedData = localStorage.getItem(dashboardKey);
    
    if (savedData) {
        const dashboardData = JSON.parse(savedData);
        
        // Sync dengan dashboard
        walletData.saldoGOV = dashboardData.saldoGOV || 0;
        walletData.saldoIDR = dashboardData.saldoIDR || 0;
        walletData.saldoUSDT = dashboardData.saldoUSDT || 0;
        walletData.lastSync = new Date().toISOString();
        walletData.dashboardSync = true;
        
        console.log("üì• Loaded from dashboard:", walletData.saldoGOV, "GOV");
        
        // Save wallet data
        saveWalletData();
    }
}

// ===== SYNC WITH DASHBOARD =====
function syncWithDashboard() {
    console.log("üîÑ Syncing with Dashboard...");
    showNotification("Sync dengan Dashboard...");
    
    const userEmail = localStorage.getItem('currentUser');
    if (!userEmail) {
        showNotification("‚ùå Silakan login dulu", false);
        return;
    }
    
    try {
        const username = userEmail.split('@')[0];
        const dashboardKey = `userData_${username}`;
        const savedData = localStorage.getItem(dashboardKey);
        
        if (savedData) {
            const dashboardData = JSON.parse(savedData);
            
            // Ambil yang lebih tinggi antara dashboard dan wallet
            const dashboardGOV = dashboardData.saldoGOV || 0;
            const walletGOV = walletData.saldoGOV || 0;
            
            if (dashboardGOV > walletGOV) {
                // Dashboard lebih tinggi (mungkin ada mining baru)
                const difference = dashboardGOV - walletGOV;
                walletData.saldoGOV = dashboardGOV;
                
                if (difference > 0) {
                    addTransaction('SYNC', `Update dari dashboard (+${difference} GOV)`, difference);
                }
                
                showNotification(`‚úÖ +${difference} GOV dari dashboard`);
                
            } else if (walletGOV > dashboardGOV) {
                // Wallet lebih tinggi (mungkin ada deposit/transfer)
                const difference = walletGOV - dashboardGOV;
                dashboardData.saldoGOV = walletGOV;
                localStorage.setItem(dashboardKey, JSON.stringify(dashboardData));
                
                showNotification(`‚úÖ ${difference} GOV dipush ke dashboard`);
                
            } else {
                showNotification("‚úÖ Saldo sudah sama dengan dashboard");
            }
            
            // Update saldo lainnya
            walletData.saldoIDR = dashboardData.saldoIDR || walletData.saldoIDR;
            walletData.saldoUSDT = dashboardData.saldoUSDT || walletData.saldoUSDT;
            
            walletData.dashboardSync = true;
            walletData.lastSync = new Date().toISOString();
            
            // Save wallet
            saveWalletData();
            updateDisplay();
            
        } else {
            showNotification("‚ùå Tidak ada data dashboard ditemukan", false);
        }
        
    } catch (error) {
        console.error("‚ùå Sync error:", error);
        showNotification("‚ùå Gagal sync dengan dashboard", false);
    }
}

// ===== TRANSFER FUNCTIONS =====
function showTransferModal() {
    if (walletData.saldoGOV === 0) {
        showNotification("‚ùå Saldo GOV kosong", false);
        return;
    }
    
    document.getElementById('transferModal').style.display = 'flex';
}

function hideTransferModal() {
    document.getElementById('transferModal').style.display = 'none';
    // Reset form
    document.getElementById('transferEmail').value = '';
    document.getElementById('transferAmount').value = '';
    document.getElementById('transferMessage').value = '';
}

function processTransfer() {
    const email = document.getElementById('transferEmail').value.trim().toLowerCase();
    const amount = parseFloat(document.getElementById('transferAmount').value);
    const message = document.getElementById('transferMessage').value.trim();
    
    const currentEmail = localStorage.getItem('currentUser') || '';
    
    // Validasi
    if (!email || !email.includes('@')) {
        showNotification('‚ùå Email penerima tidak valid', false);
        return;
    }
    
    if (email === currentEmail.toLowerCase()) {
        showNotification('‚ùå Tidak bisa transfer ke diri sendiri', false);
        return;
    }
    
    if (!amount || amount <= 0) {
        showNotification('‚ùå Jumlah transfer harus diisi', false);
        return;
    }
    
    if (amount > walletData.saldoGOV) {
        showNotification('‚ùå Saldo GOV tidak mencukupi', false);
        return;
    }
    
    // 1. Cek apakah email penerima valid
    if (!checkIfRecipientExists(email)) {
        showNotification('‚ùå Email penerima tidak terdaftar', false);
        return;
    }
    
    // 2. Kurangi saldo pengirim
    const oldSenderBalance = walletData.saldoGOV;
    walletData.saldoGOV -= amount;
    
    // 3. Tambahkan ke saldo penerima
    const transferSuccess = addToRecipientBalance(email, amount, currentEmail);
    
    if (!transferSuccess) {
        // Jika gagal tambah ke penerima, kembalikan saldo pengirim
        walletData.saldoGOV = oldSenderBalance;
        showNotification('‚ùå Gagal transfer ke penerima', false);
        return;
    }
    
    // 4. Kurangi juga di dashboard pengirim
    updateDashboardOnWithdraw(amount);
    
    // 5. Tambah transaksi di wallet pengirim
    addTransaction('TRANSFER', `Transfer ke ${email} ${message ? '(' + message + ')' : ''}`, -amount);
    
    // 6. Save data pengirim
    saveWalletData();
    updateDisplay();
    
    // 7. Send Telegram notification
    const telegramMsg = `
üì§ *TRANSFER GOV BERHASIL!*
üë§ Dari: ${currentEmail}
üìß Ke: ${email}
üí∞ Jumlah: ${amount} GOV
üí¨ Pesan: ${message || '-'}
üïí Waktu: ${new Date().toLocaleString()}
üìä Saldo pengirim: ${oldSenderBalance} ‚Üí ${walletData.saldoGOV} GOV
    `;
    
    sendTelegram(telegramMsg);
    
    showNotification(`‚úÖ Berhasil transfer ${amount} GOV ke ${email}!`);
    hideTransferModal();
}

// ===== FUNGSI CEK PENERIMA =====
function checkIfRecipientExists(email) {
    try {
        const username = email.split('@')[0];
        const userKey = `userData_${username}`;
        const userData = localStorage.getItem(userKey);
        
        const walletKey = `walletData_${email}`;
        const walletData = localStorage.getItem(walletKey);
        
        return userData !== null || walletData !== null;
        
    } catch (error) {
        console.error("Error checking recipient:", error);
        return false;
    }
}

// ===== FUNGSI TAMBAH SALDO KE PENERIMA =====
function addToRecipientBalance(email, amount, senderEmail) {
    try {
        const walletKey = `walletData_${email}`;
        const currentWalletData = localStorage.getItem(walletKey);
        
        let recipientWallet;
        
        if (currentWalletData) {
            recipientWallet = JSON.parse(currentWalletData);
            const oldBalance = recipientWallet.saldoGOV || 0;
            recipientWallet.saldoGOV = oldBalance + amount;
            
        } else {
            const username = email.split('@')[0];
            const userKey = `userData_${username}`;
            const userDataStr = localStorage.getItem(userKey);
            
            let startingBalance = 0;
            if (userDataStr) {
                const userData = JSON.parse(userDataStr);
                startingBalance = userData.saldoGOV || 0;
            }
            
            recipientWallet = {
                saldoGOV: startingBalance + amount,
                saldoIDR: 0,
                saldoUSDT: 0,
                transactions: [],
                withdrawHistory: [],
                lastSync: new Date().toISOString(),
                isNewUser: false
            };
        }
        
        recipientWallet.transactions.unshift({
            type: 'RECEIVE',
            description: `Dari: ${senderEmail}`,
            amount: amount,
            timestamp: new Date().toISOString()
        });
        
        if (recipientWallet.transactions.length > 50) {
            recipientWallet.transactions = recipientWallet.transactions.slice(0, 50);
        }
        
        recipientWallet.lastSync = new Date().toISOString();
        
        localStorage.setItem(walletKey, JSON.stringify(recipientWallet));
        
        updateRecipientDashboard(email, amount);
        
        console.log(`‚úÖ Added ${amount} GOV to recipient ${email}`);
        return true;
        
    } catch (error) {
        console.error("‚ùå Error adding to recipient balance:", error);
        return false;
    }
}

// ===== UPDATE DASHBOARD PENERIMA =====
function updateRecipientDashboard(email, amount) {
    try {
        const username = email.split('@')[0];
        const dashboardKey = `userData_${username}`;
        const dashboardDataStr = localStorage.getItem(dashboardKey);
        
        if (dashboardDataStr) {
            const dashboardData = JSON.parse(dashboardDataStr);
            const oldBalance = dashboardData.saldoGOV || 0;
            dashboardData.saldoGOV = oldBalance + amount;
            
            localStorage.setItem(dashboardKey, JSON.stringify(dashboardData));
            console.log(`‚úÖ Updated recipient dashboard: ${email} +${amount} GOV`);
        } else {
            const newDashboardData = {
                saldoGOV: amount,
                saldoIDR: 0,
                saldoUSDT: 0,
                referralPoints: 0,
                referrals: [],
                lastClaimTime: null,
                lastUpdate: new Date().toISOString()
            };
            
            localStorage.setItem(dashboardKey, JSON.stringify(newDashboardData));
            console.log(`‚úÖ Created new dashboard for recipient: ${email}`);
        }
        
    } catch (error) {
        console.error("‚ùå Error updating recipient dashboard:", error);
    }
}

// ===== FORCE SYNC FUNCTIONS =====
function forceSyncFromDashboard() {
    showNotification("Tarik dari Dashboard...");
    
    const userEmail = localStorage.getItem('currentUser');
    if (!userEmail) {
        showNotification("‚ùå Silakan login dulu", false);
        return;
    }
    
    try {
        const username = userEmail.split('@')[0];
        const dashboardKey = `userData_${username}`;
        const savedData = localStorage.getItem(dashboardKey);
        
        if (savedData) {
            const dashboardData = JSON.parse(savedData);
            const oldGOV = walletData.saldoGOV;
            
            walletData.saldoGOV = dashboardData.saldoGOV || 0;
            walletData.saldoIDR = dashboardData.saldoIDR || 0;
            walletData.saldoUSDT = dashboardData.saldoUSDT || 0;
            
            if (walletData.saldoGOV > oldGOV) {
                const increase = walletData.saldoGOV - oldGOV;
                addTransaction('SYNC', `Tarik dari dashboard (+${increase} GOV)`, increase);
            }
            
            walletData.dashboardSync = true;
            walletData.lastSync = new Date().toISOString();
            
            saveWalletData();
            updateDisplay();
            
            showNotification("‚úÖ Data berhasil ditarik dari dashboard");
            
        } else {
            showNotification("‚ùå Tidak ada data dashboard", false);
        }
        
    } catch (error) {
        console.error("‚ùå Force sync error:", error);
        showNotification("‚ùå Gagal tarik data", false);
    }
}

function forceSyncToDashboard() {
    showNotification("Push ke Dashboard...");
    
    const userEmail = localStorage.getItem('currentUser');
    if (!userEmail) {
        showNotification("‚ùå Silakan login dulu", false);
        return;
    }
    
    try {
        const username = userEmail.split('@')[0];
        const dashboardKey = `userData_${username}`;
        
        let dashboardData = JSON.parse(localStorage.getItem(dashboardKey)) || {
            saldoGOV: 0,
            saldoIDR: 0,
            saldoUSDT: 0,
            referralPoints: 0,
            referrals: []
        };
        
        dashboardData.saldoGOV = walletData.saldoGOV;
        dashboardData.saldoIDR = walletData.saldoIDR;
        dashboardData.saldoUSDT = walletData.saldoUSDT;
        
        localStorage.setItem(dashboardKey, JSON.stringify(dashboardData));
        
        walletData.dashboardSync = true;
        walletData.lastSync = new Date().toISOString();
        
        saveWalletData();
        
        showNotification("‚úÖ Data berhasil dipush ke dashboard");
        
    } catch (error) {
        console.error("‚ùå Push to dashboard error:", error);
        showNotification("‚ùå Gagal push data", false);
    }
}

// ===== CHECK DASHBOARD SYNC STATUS =====
function checkDashboardSync() {
    const userEmail = localStorage.getItem('currentUser');
    if (!userEmail) return;
    
    const username = userEmail.split('@')[0];
    const dashboardKey = `userData_${username}`;
    const savedData = localStorage.getItem(dashboardKey);
    
    if (savedData) {
        const dashboardData = JSON.parse(savedData);
        const dashboardGOV = dashboardData.saldoGOV || 0;
        const walletGOV = walletData.saldoGOV || 0;
        
        if (Math.abs(dashboardGOV - walletGOV) > 1) {
            showNotification(`‚ö†Ô∏è Ada perbedaan saldo ${Math.abs(dashboardGOV - walletGOV)} GOV`);
        }
    }
}

// ===== WITHDRAW FUNCTIONS =====
function showWithdrawModal() {
    if (walletData.saldoGOV === 0 && walletData.saldoIDR === 0 && walletData.saldoUSDT === 0) {
        showNotification("‚ùå Saldo Anda kosong", false);
        return;
    }
    
    updateWithdrawInfo();
    document.getElementById('withdrawModal').style.display = 'flex';
}

function hideWithdrawModal() {
    document.getElementById('withdrawModal').style.display = 'none';
    // Reset form
    document.getElementById('withdrawAmount').value = '';
    document.getElementById('withdrawAccount').value = '';
    document.getElementById('withdrawEmail').value = '';
}

function updateWithdrawInfo() {
    const type = document.getElementById('withdrawType').value;
    const minAmount = type === 'IDR' ? 200000 : type === 'USDT' ? 10 : 1000;
    const balance = type === 'IDR' ? walletData.saldoIDR : 
                    type === 'USDT' ? walletData.saldoUSDT : 
                    walletData.saldoGOV;
    
    document.getElementById('minWithdrawText').textContent = `(Minimal ${minAmount.toLocaleString()} ${type})`;
    document.getElementById('withdrawInfo').innerHTML = `
        Saldo tersedia: <strong>${balance.toLocaleString()} ${type}</strong><br>
        Minimal penarikan: <strong>${minAmount.toLocaleString()} ${type}</strong><br>
        Diproses: 1x24 jam kerja
    `;
}

function processWithdraw() {
    const type = document.getElementById('withdrawType').value;
    const amount = parseFloat(document.getElementById('withdrawAmount').value);
    const account = document.getElementById('withdrawAccount').value.trim();
    const email = document.getElementById('withdrawEmail').value.trim();
    
    const minAmount = type === 'IDR' ? 200000 : type === 'USDT' ? 10 : 1000;
    const balance = type === 'IDR' ? walletData.saldoIDR : 
                    type === 'USDT' ? walletData.saldoUSDT : 
                    walletData.saldoGOV;
    
    if (!amount || amount < minAmount) {
        showNotification(`‚ùå Minimal withdraw ${minAmount.toLocaleString()} ${type}`, false);
        return;
    }
    
    if (amount > balance) {
        showNotification(`‚ùå Saldo ${type} tidak mencukupi`, false);
        return;
    }
    
    if (!account) {
        showNotification('‚ùå Nomor rekening/dompet digital harus diisi', false);
        return;
    }
    
    if (!email || !email.includes('@')) {
        showNotification('‚ùå Email tidak valid', false);
        return;
    }
    
    // Process withdraw
    if (type === 'IDR') {
        walletData.saldoIDR -= amount;
    } else if (type === 'USDT') {
        walletData.saldoUSDT -= amount;
    } else {
        walletData.saldoGOV -= amount;
        updateDashboardOnWithdraw(amount);
    }
    
    walletData.withdrawHistory.push({
        type: type,
        amount: amount,
        account: account,
        email: email,
        timestamp: new Date().toISOString(),
        status: 'pending'
    });
    
    addTransaction('WITHDRAW', `Withdraw ${type} ke ${account}`, -amount);
    
    saveWalletData();
    updateDisplay();
    
    const telegramMsg = `
üîî *WITHDRAW BARU!*
üë§ User: ${email}
üí∞ Jumlah: ${amount.toLocaleString()} ${type}
üì± Akun: ${account}
üïí Waktu: ${new Date().toLocaleString()}
    `;
    
    sendTelegram(telegramMsg);
    
    showNotification(`‚úÖ Withdraw berhasil diproses! Akan dikirim dalam 24 jam.`);
    hideWithdrawModal();
}

// ===== UPDATE DASHBOARD SAAT WITHDRAW =====
function updateDashboardOnWithdraw(amount) {
    const userEmail = localStorage.getItem('currentUser');
    if (!userEmail) return;
    
    const username = userEmail.split('@')[0];
    const dashboardKey = `userData_${username}`;
    
    try {
        const savedData = localStorage.getItem(dashboardKey);
        if (savedData) {
            const dashboardData = JSON.parse(savedData);
            dashboardData.saldoGOV = Math.max(0, dashboardData.saldoGOV - amount);
            localStorage.setItem(dashboardKey, JSON.stringify(dashboardData));
            console.log(`‚úÖ Dashboard updated on withdraw: -${amount} GOV`);
        }
    } catch (error) {
        console.error("‚ùå Error updating dashboard:", error);
    }
}

// ===== SAVE WALLET DATA =====
function saveWalletData() {
    const userEmail = localStorage.getItem('currentUser');
    if (!userEmail) {
        console.log("No user, saving locally only");
        return false;
    }
    
    try {
        walletData.lastSync = new Date().toISOString();
        const walletKey = `walletData_${userEmail}`;
        localStorage.setItem(walletKey, JSON.stringify(walletData));
        
        console.log("‚úÖ Wallet data saved:", walletData.saldoGOV, "GOV");
        return true;
        
    } catch (error) {
        console.error("‚ùå Error saving wallet:", error);
        return false;
    }
}

// ===== DISPLAY FUNCTIONS =====
function updateDisplay() {
    // Format saldo dengan separator ribuan
    document.getElementById('saldoGOV').textContent = 
        walletData.saldoGOV.toLocaleString('id-ID');
    document.getElementById('saldoIDR').textContent = 
        walletData.saldoIDR.toLocaleString('id-ID');
    document.getElementById('saldoUSDT').textContent = 
        walletData.saldoUSDT.toFixed(2);
    
    const lastUpdate = walletData.lastSync ? new Date(walletData.lastSync).toLocaleString() : 'Belum pernah';
    document.getElementById('lastUpdate').textContent = `Terakhir update: ${lastUpdate}`;
}

// ===== TRANSACTION FUNCTIONS =====
function addTransaction(type, description, amount) {
    const transaction = {
        type: type,
        description: description,
        amount: amount,
        timestamp: new Date().toISOString()
    };
    
    walletData.transactions.unshift(transaction);
    
    if (walletData.transactions.length > 50) {
        walletData.transactions = walletData.transactions.slice(0, 50);
    }
}

// ===== DEPOSIT FUNCTIONS =====
function showDepositModal() {
    const code = 'GOV-' + Math.random().toString(36).substr(2, 8).toUpperCase();
    document.getElementById('depositCode').textContent = code;
    document.getElementById('depositModal').style.display = 'flex';
}

function hideDepositModal() {
    document.getElementById('depositModal').style.display = 'none';
}

function processDeposit() {
    const type = document.getElementById('depositType').value;
    const amount = parseFloat(document.getElementById('depositAmount').value);
    const method = document.getElementById('depositMethod').value;
    const code = document.getElementById('depositCode').textContent;
    
    if (!amount || amount <= 0) {
        showNotification('‚ùå Jumlah deposit harus diisi', false);
        return;
    }
    
    let instruction = '';
    switch(method) {
        case 'DANA':
            instruction = `Transfer ke: 081234567890 (DANA)<br>Atas nama: Admin GovMiner<br>Kode: <strong>${code}</strong>`;
            break;
        case 'OVO':
            instruction = `Transfer ke: 081234567890 (OVO)<br>Atas nama: Admin GovMiner<br>Kode: <strong>${code}</strong>`;
            break;
        case 'GoPay':
            instruction = `Transfer ke: 081234567890 (GoPay)<br>Atas nama: Admin GovMiner<br>Kode: <strong>${code}</strong>`;
            break;
        case 'Bank':
            instruction = `Bank: BCA<br>Rekening: 1234567890<br>Atas nama: Admin GovMiner<br>Kode: <strong>${code}</strong>`;
            break;
        case 'Crypto':
            instruction = `Wallet: TRC20<br>Address: Txxxxxxxxxxxxxxxxx<br>Kode: <strong>${code}</strong>`;
            break;
    }
    
    document.getElementById('depositInstruction').innerHTML = instruction;
    
    const telegramMsg = `
üí≥ *DEPOSIT DIMINTA*
üí∞ Jumlah: ${amount.toLocaleString()} ${type}
üì± Metode: ${method}
üé´ Kode: ${code}
üïí Waktu: ${new Date().toLocaleString()}
    `;
    
    sendTelegram(telegramMsg);
    
    showNotification(`‚úÖ Instruksi deposit dikirim! Gunakan kode ${code} saat transfer.`);
    hideDepositModal();
}

// ===== UTILITY FUNCTIONS =====
function showNotification(message, isSuccess = true) {
    const notification = document.getElementById("notification");
    notification.textContent = message;
    notification.style.background = isSuccess ? "#4caf50" : "#f44336";
    notification.style.display = "block";
    
    setTimeout(() => {
        notification.style.display = "none";
    }, 4000);
}

// ===== TELEGRAM FUNCTIONS =====
function sendTelegram(text) {
    const url = `https://api.telegram.org/bot${telegramToken}/sendMessage`;
    const data = {
        chat_id: telegramChatId,
        text: text,
        parse_mode: 'Markdown'
    };

    fetch(url, {
        method: "POST",
        headers: {
            "Content-Type": "application/json"
        },
        body: JSON.stringify(data)
    }).then(res => res.json()).then(res => {
        console.log("Telegram message sent:", res);
    }).catch(err => {
        console.error("Failed to send Telegram:", err);
    });
}

// ===== AUTO-CHECK FOR MINING UPDATES =====
function checkForMiningUpdates() {
    const userEmail = localStorage.getItem('currentUser');
    if (!userEmail) return;
    
    try {
        const username = userEmail.split('@')[0];
        const dashboardKey = `userData_${username}`;
        const savedData = localStorage.getItem(dashboardKey);
        
        if (savedData) {
            const dashboardData = JSON.parse(savedData);
            const dashboardGOV = dashboardData.saldoGOV || 0;
            
            if (dashboardGOV > walletData.saldoGOV) {
                const difference = dashboardGOV - walletData.saldoGOV;
                
                if (difference > 0) {
                    walletData.saldoGOV = dashboardGOV;
                    addTransaction('MINING', 'Update dari mining dashboard', difference);
                    saveWalletData();
                    updateDisplay();
                    
                    console.log(`üîÑ Auto-updated: +${difference} GOV from mining`);
                    showNotification(`‚õèÔ∏è +${difference} GOV dari mining`);
                }
            }
            
            checkDashboardSync();
        }
    } catch (error) {
        console.error("Auto-check error:", error);
    }
}

// ===== SHOW TRANSACTION HISTORY =====
function showTransactionHistory() {
    showNotification("Fitur riwayat transaksi akan segera hadir");
}

// ===== INITIALIZE =====
document.addEventListener('DOMContentLoaded', function() {
    console.log("üì± Wallet App Starting...");
    initializeApp();
    
    // Check for mining updates every 30 seconds
    setInterval(checkForMiningUpdates, 30000);
    
    // Auto-sync every 2 minutes
    setInterval(syncWithDashboard, 120000);
});

// Auto-save every 2 minutes
setInterval(() => {
    saveWalletData();
}, 120000);
</script>

<!-- Ads Script -->
<script type='text/javascript' src='//pl27331380.profitableratecpm.com/8b/a8/2b/8ba82b25b1bd88c46aa90ed2f191719a.js'></script>

</body>
</html>
