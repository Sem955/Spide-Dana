<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GOV Wallet</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; color: white; }
        .container { max-width: 480px; margin: 0 auto; padding: 20px; padding-bottom: 80px; }
        .wallet-header { padding: 30px 0 40px; text-align: center; }
        .wallet-title { font-size: 36px; font-weight: 800; margin-bottom: 8px; text-shadow: 0 2px 10px rgba(0,0,0,0.2); }
        .wallet-subtitle { color: rgba(255,255,255,0.8); font-size: 14px; }
        .balance-card { background: rgba(255, 255, 255, 0.15); backdrop-filter: blur(20px); border-radius: 24px; padding: 30px; margin-bottom: 25px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); text-align: center; border: 1px solid rgba(255,255,255,0.2); }
        .total-balance-label { color: rgba(255,255,255,0.8); font-size: 16px; margin-bottom: 10px; }
        .balance-amount { font-size: 48px; font-weight: 700; margin-bottom: 10px; text-shadow: 0 2px 10px rgba(0,0,0,0.3); }
        .balance-in-idr { color: rgba(255,255,255,0.8); font-size: 16px; }
        .action-buttons { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 30px; }
        .action-btn { background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 15px; padding: 18px 10px; text-align: center; color: white; cursor: pointer; transition: all 0.3s ease; display: flex; flex-direction: column; align-items: center; gap: 10px; }
        .action-btn-icon { font-size: 26px; }
        .action-btn-text { font-size: 12px; font-weight: 600; }
        .assets-section { background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(20px); border-radius: 20px; padding: 25px; margin-bottom: 30px; border: 1px solid rgba(255,255,255,0.2); }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .assets-list { display: flex; flex-direction: column; gap: 12px; }
        .asset-item { background: rgba(255, 255, 255, 0.08); border-radius: 18px; padding: 20px; display: flex; align-items: center; justify-content: space-between; border: 1px solid rgba(255,255,255,0.1); }
        .asset-info { display: flex; align-items: center; gap: 15px; }
        .asset-icon { width: 50px; height: 50px; border-radius: 15px; display: flex; align-items: center; justify-content: center; font-size: 24px; font-weight: 700; background: rgba(255,255,255,0.15); border: 2px solid rgba(255,255,255,0.3); }
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; max-width: 480px; margin: 0 auto; background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(20px); border-top: 1px solid rgba(255, 255, 255, 0.2); padding: 15px 20px; display: flex; justify-content: space-between; border-radius: 25px 25px 0 0; }
        .nav-item { display: flex; flex-direction: column; align-items: center; gap: 6px; color: rgba(255,255,255,0.7); cursor: pointer; }
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.8); z-index: 1000; justify-content: center; align-items: center; backdrop-filter: blur(10px); padding: 20px; }
        .modal-content { background: white; border-radius: 25px; width: 100%; max-width: 400px; padding: 30px; max-height: 90vh; overflow-y: auto; color: #333; }
        .form-group { margin-bottom: 15px; }
        .form-input { width: 100%; padding: 14px; background: #f5f5f7; border: 2px solid #e0e0e0; border-radius: 12px; font-size: 16px; }
        .payment-methods { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 15px 0; }
        .payment-method { border: 2px solid #eee; border-radius: 12px; padding: 12px; text-align: center; cursor: pointer; }
        .payment-method.selected { border-color: #667eea; background: #f0f4ff; }
        .primary-btn { width: 100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 12px; padding: 16px; font-weight: 600; cursor: pointer; }
        .primary-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        #notification { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); padding: 15px 25px; border-radius: 12px; color: white; z-index: 2000; display: none; }
    </style>
</head>
<body>

<div id="notification"></div>

<div class="container">
    <div class="wallet-header">
        <div class="wallet-title">GOV Wallet</div>
        <div class="wallet-subtitle" id="userEmail">Loading...</div>
    </div>
    
    <div class="balance-card">
        <div class="total-balance-label">Total Saldo</div>
        <div class="balance-amount" id="totalBalance">Rp 0</div>
        <div class="balance-in-idr" id="totalBalanceUSD">$0.00</div>
    </div>
    
    <div class="action-buttons">
        <div class="action-btn" onclick="showModal('transferModal')">
            <div class="action-btn-icon">üí∏</div>
            <div class="action-btn-text">Transfer</div>
        </div>
        <div class="action-btn" onclick="showWithdrawModal()">
            <div class="action-btn-icon">üì§</div>
            <div class="action-btn-text">Withdraw</div>
        </div>
        <div class="action-btn" onclick="showSwapModal()">
            <div class="action-btn-icon">üîÑ</div>
            <div class="action-btn-text">Swap</div>
        </div>
        <div class="action-btn" onclick="showHistory()">
            <div class="action-btn-icon">üìã</div>
            <div class="action-btn-text">Riwayat</div>
        </div>
    </div>
    
    <div class="assets-section">
        <div class="section-header"><b>Aset Anda</b></div>
        <div class="assets-list">
            <div class="asset-item">
                <div class="asset-info"><div class="asset-icon">G</div><div><b>GOV</b></div></div>
                <div id="govBalance">0 GOV</div>
            </div>
            <div class="asset-item">
                <div class="asset-info"><div class="asset-icon">Rp</div><div><b>IDR</b></div></div>
                <div id="idrBalance">Rp 0</div>
            </div>
            <div class="asset-item">
                <div class="asset-info"><div class="asset-icon">$</div><div><b>USDT</b></div></div>
                <div id="usdtBalance">0 USDT</div>
            </div>
        </div>
    </div>
</div>

<div id="withdrawModal" class="modal-overlay">
    <div class="modal-content">
        <h3>üì§ Withdraw IDR</h3>
        <p style="font-size: 12px; margin-bottom: 10px;">Saldo: <span id="availIDR">0</span></p>
        
        <div class="form-group">
            <input type="number" id="withdrawAmount" class="form-input" placeholder="Jumlah (Min 10000)" oninput="validateWithdraw()">
        </div>
        
        <div class="payment-methods">
            <div class="payment-method" id="danaBtn" onclick="selectPay('dana')">DANA<br><small>Fee 2rb</small></div>
            <div class="payment-method" id="gopayBtn" onclick="selectPay('gopay')">GoPay<br><small>Fee 2.5rb</small></div>
        </div>

        <div class="form-group">
            <input type="tel" id="withdrawPhone" class="form-input" placeholder="Nomor HP" oninput="validateWithdraw()">
        </div>
        <div class="form-group">
            <input type="text" id="withdrawName" class="form-input" placeholder="Nama Akun" oninput="validateWithdraw()">
        </div>

        <button id="withdrawBtn" class="primary-btn" onclick="processWithdraw()" disabled>Withdraw Sekarang</button>
        <button class="secondary-btn" style="width:100%; margin-top:10px; padding:10px; border:none;" onclick="hideModal('withdrawModal')">Batal</button>
    </div>
</div>

<div id="swapModal" class="modal-overlay">
    <div class="modal-content">
        <h3>üîÑ Swap Aset</h3>
        <div class="form-group">
            <label style="font-size:12px">Dari</label>
            <select id="swapFrom" class="form-input" onchange="updateSwapCalc()">
                <option value="GOV">GOV</option>
                <option value="IDR">IDR</option>
                <option value="USDT">USDT</option>
            </select>
        </div>
        <div class="form-group">
            <label style="font-size:12px">Ke</label>
            <select id="swapTo" class="form-input" onchange="updateSwapCalc()">
                <option value="USDT">USDT</option>
                <option value="IDR">IDR</option>
                <option value="GOV">GOV</option>
            </select>
        </div>
        <div class="form-group">
            <input type="number" id="swapAmount" class="form-input" placeholder="Jumlah" oninput="updateSwapCalc()">
        </div>
        <div id="swapResult" style="margin-bottom:15px; font-weight:bold; color:#667eea">Estimasi: 0</div>
        <button id="swapBtn" class="primary-btn" onclick="processSwap()" disabled>Konfirmasi Swap</button>
        <button class="secondary-btn" style="width:100%; margin-top:10px; padding:10px; border:none;" onclick="hideModal('swapModal')">Tutup</button>
    </div>
</div>

<script>
// --- CONFIG & DATA ---
const firebaseConfig = {
    apiKey: "AIzaSyBY7wHgWh7_0HqRLHzDnwdfQOhv_ziqA3A",
    authDomain: "govin-28f84.firebaseapp.com",
    databaseURL: "https://govin-28f84-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "govin-28f84",
    storageBucket: "govin-28f84.firebasestorage.app",
    messagingSenderId: "833155210577",
    appId: "1:833155210577:web:bc3ab48e50732670a77067"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();
let wallet = { GOV: 0, IDR: 0, USDT: 0 };
let method = null;
let uid = "";

// --- INIT ---
window.onload = function() {
    const user = localStorage.getItem('currentUser');
    if(!user) return window.location.href="index.html";
    document.getElementById('userEmail').textContent = user;
    uid = btoa(user).replace(/[^a-zA-Z0-9]/g, '');

    db.ref('wallets/' + uid).on('value', snap => {
        if(snap.exists()) {
            wallet = snap.val().balances;
            updateUI();
        }
    });
};

function updateUI() {
    document.getElementById('govBalance').textContent = wallet.GOV.toLocaleString() + " GOV";
    document.getElementById('idrBalance').textContent = "Rp " + wallet.IDR.toLocaleString();
    document.getElementById('usdtBalance').textContent = wallet.USDT.toLocaleString() + " USDT";
    
    const total = (wallet.GOV * 16.8) + wallet.IDR + (wallet.USDT * 16800);
    document.getElementById('totalBalance').textContent = "Rp " + Math.floor(total).toLocaleString();
    document.getElementById('totalBalanceUSD').textContent = "$" + (total/16800).toFixed(2);
}

// --- WITHDRAW LOGIC ---
function showWithdrawModal() {
    document.getElementById('availIDR').textContent = "Rp " + wallet.IDR.toLocaleString();
    document.getElementById('withdrawModal').style.display = 'flex';
}

function selectPay(m) {
    method = m;
    document.getElementById('danaBtn').className = 'payment-method' + (m==='dana'?' selected':'');
    document.getElementById('gopayBtn').className = 'payment-method' + (m==='gopay'?' selected':'');
    validateWithdraw();
}

function validateWithdraw() {
    const amt = parseFloat(document.getElementById('withdrawAmount').value) || 0;
    const phone = document.getElementById('withdrawPhone').value;
    const name = document.getElementById('withdrawName').value;
    const fee = method === 'dana' ? 2000 : 2500;
    
    const isReady = (amt >= 10000) && (amt + fee <= wallet.IDR) && (phone.length > 9) && (name.length > 2) && method;
    document.getElementById('withdrawBtn').disabled = !isReady;
}

async function processWithdraw() {
    const amt = parseFloat(document.getElementById('withdrawAmount').value);
    const fee = method === 'dana' ? 2000 : 2500;
    const phone = document.getElementById('withdrawPhone').value;
    const name = document.getElementById('withdrawName').value;

    wallet.IDR -= (amt + fee);
    
    const tx = {
        type: "WITHDRAW",
        amount: amt,
        fee: fee,
        method: method.toUpperCase(),
        phone: phone,
        name: name,
        timestamp: Date.now()
    };

    await db.ref('wallets/'+uid+'/balances').set(wallet);
    sendTelegram(tx);
    hideModal('withdrawModal');
    showNotif("‚úÖ Withdraw berhasil diajukan!");
}

// --- SWAP LOGIC ---
function showSwapModal() { document.getElementById('swapModal').style.display = 'flex'; }

function updateSwapCalc() {
    const from = document.getElementById('swapFrom').value;
    const to = document.getElementById('swapTo').value;
    const amt = parseFloat(document.getElementById('swapAmount').value) || 0;
    let res = 0;

    if(from === 'GOV' && to === 'USDT') res = amt * 0.001;
    else if(from === 'GOV' && to === 'IDR') res = amt * 16.8;
    else if(from === 'USDT' && to === 'GOV') res = amt * 1000;
    else if(from === 'USDT' && to === 'IDR') res = amt * 16800;
    else if(from === 'IDR' && to === 'GOV') res = amt / 16.8;
    else if(from === 'IDR' && to === 'USDT') res = amt / 16800;

    document.getElementById('swapResult').textContent = "Estimasi: " + res.toFixed(4) + " " + to;
    document.getElementById('swapBtn').disabled = !(amt > 0 && amt <= wallet[from] && from !== to);
}

async function processSwap() {
    const from = document.getElementById('swapFrom').value;
    const to = document.getElementById('swapTo').value;
    const amt = parseFloat(document.getElementById('swapAmount').value);
    
    let res = 0;
    if(from === 'GOV' && to === 'USDT') res = amt * 0.001;
    else if(from === 'GOV' && to === 'IDR') res = amt * 16.8;
    else if(from === 'USDT' && to === 'GOV') res = amt * 1000;
    else if(from === 'USDT' && to === 'IDR') res = amt * 16800;
    else if(from === 'IDR' && to === 'GOV') res = amt / 16.8;
    else if(from === 'IDR' && to === 'USDT') res = amt / 16800;

    wallet[from] -= amt;
    wallet[to] += res;

    await db.ref('wallets/'+uid+'/balances').set(wallet);
    hideModal('swapModal');
    showNotif("‚úÖ Swap Berhasil!");
}

// --- UTILS ---
function hideModal(id) { 
    document.getElementById(id).style.display = 'none'; 
    method = null;
}

function showNotif(m) {
    const n = document.getElementById('notification');
    n.textContent = m;
    n.style.display = 'block';
    n.style.background = '#4cd964';
    setTimeout(() => n.style.display = 'none', 3000);
}

function sendTelegram(tx) {
    const token = "8056079965:AAGm9XzWwX_wF_Vf_X_zWwX_wF_Vf_X_zWw"; // Ganti dengan token asli
    const chat = "6616645511"; // Ganti dengan chat id asli
    const user = localStorage.getItem('currentUser');
    
    const text = `üì§ *WITHDRAW REQUEST*%0A%0A` +
                 `üë§ User: ${user}%0A` +
                 `üí∞ Nominal: Rp ${tx.amount.toLocaleString()}%0A` +
                 `üè¶ Bank: ${tx.method}%0A` +
                 `üì± No: ${tx.phone}%0A` +
                 `üìõ Nama: ${tx.name}%0A` +
                 `‚è∞ Jam: ${new Date().toLocaleString()}`;

    fetch(`https://api.telegram.org/bot${token}/sendMessage?chat_id=${chat}&text=${text}&parse_mode=Markdown`);
}
</script>
</body>
</html>
