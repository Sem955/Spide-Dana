<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dompet Digital - Sync Otomatis</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: Arial; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 500px; margin: auto; background: white; border-radius: 20px; padding: 30px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
        h1 { text-align: center; color: #333; margin-bottom: 10px; }
        .subtitle { text-align: center; color: #666; margin-bottom: 30px; }
        .status { padding: 10px; border-radius: 10px; margin: 20px 0; text-align: center; font-weight: bold; }
        .online { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .offline { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .wallet-card { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 25px; border-radius: 15px; margin: 25px 0; }
        .balance { display: flex; justify-content: space-between; margin: 15px 0; font-size: 18px; padding: 10px 0; border-bottom: 1px solid rgba(255,255,255,0.2); }
        .balance:last-child { border-bottom: none; }
        button { width: 100%; padding: 16px; margin: 10px 0; border: none; border-radius: 12px; font-size: 16px; font-weight: bold; cursor: pointer; transition: transform 0.2s; }
        button:hover { transform: translateY(-2px); }
        .btn-primary { background: #1890ff; color: white; }
        .btn-success { background: #52c41a; color: white; }
        .btn-warning { background: #faad14; color: white; }
        .sync-indicator { position: fixed; top: 20px; right: 20px; background: #1890ff; color: white; padding: 8px 16px; border-radius: 20px; font-size: 14px; display: none; z-index: 1000; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }
        .user-info { text-align: center; padding: 15px; background: #f8f9fa; border-radius: 10px; margin: 15px 0; }
    </style>
</head>
<body>

<div class="sync-indicator" id="syncIndicator"></div>

<div class="container">
    <h1>ðŸ’° Dompet Digital</h1>
    <div class="subtitle">Saldo Sync Otomatis Antar HP</div>
    
    <!-- Connection Status -->
    <div id="connectionStatus" class="status offline">ðŸ”´ Menghubungkan...</div>
    
    <!-- User Info -->
    <div class="user-info" id="userInfo">
        <div id="userEmail">Belum login</div>
        <div id="userUID" style="font-size: 12px; color: #666; margin-top: 5px;"></div>
    </div>
    
    <!-- Wallet Card -->
    <div class="wallet-card">
        <h2 style="text-align: center; margin-bottom: 20px;">Saldo Anda</h2>
        <div class="balance">
            <span>GOV Coin</span>
            <span id="saldoGOV">0 GOV</span>
        </div>
        <div class="balance">
            <span>Rupiah (IDR)</span>
            <span id="saldoIDR">Rp 0</span>
        </div>
        <div class="balance">
            <span>USDT</span>
            <span id="saldoUSDT">0.00 USDT</span>
        </div>
    </div>
    
    <!-- Action Buttons -->
    <button class="btn-primary" onclick="tambahSaldo('GOV', 100)">âž• Tambah 100 GOV</button>
    <button class="btn-primary" onclick="tambahSaldo('IDR', 50000)">âž• Tambah 50,000 IDR</button>
    <button class="btn-primary" onclick="tambahSaldo('USDT', 10)">âž• Tambah 10 USDT</button>
    
    <button class="btn-success" onclick="loginTest()">ðŸ”‘ Login Test (ddd3@gmail.com)</button>
    <button class="btn-warning" onclick="logout()">ðŸšª Logout</button>
    
    <!-- Debug Info -->
    <div style="margin-top: 30px; padding: 15px; background: #f8f9fa; border-radius: 10px; font-size: 13px;">
        <strong>ðŸ“Š Status Sistem:</strong>
        <div id="debugInfo" style="margin-top: 10px;"></div>
    </div>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script>
// ===== FIREBASE CONFIG =====
const firebaseConfig = {
    apiKey: "AIzaSyAlXIQ42acjO8xZH-Ti__YL6h9SGQQKQto",
    authDomain: "govminer.firebaseapp.com",
    databaseURL: "https://govminer-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "govminer",
    storageBucket: "govminer.firebasestorage.app",
    messagingSenderId: "408110658500",
    appId: "1:408110658500:web:3fe7f4bd9a35f3fe726a91"
};

// ===== GLOBAL VARIABLES =====
let auth = null;
let database = null;
let currentUser = null;
let currentBalance = { GOV: 0, IDR: 0, USDT: 0 };

// ===== INITIALIZE =====
function initializeFirebase() {
    try {
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        auth = firebase.auth();
        database = firebase.database();
        
        updateDebugInfo("âœ… Firebase initialized");
        updateConnectionStatus("ðŸŸ¢ Terhubung ke Server");
        
        // Setup auth listener
        auth.onAuthStateChanged(handleAuthStateChange);
        
        // Check if user was logged in before
        const savedUser = localStorage.getItem('currentUser');
        if (savedUser) {
            try {
                const userData = JSON.parse(savedUser);
                document.getElementById('userEmail').textContent = `Welcome back: ${userData.email}`;
            } catch (e) {
                // Ignore error
            }
        }
        
    } catch (error) {
        console.error("Firebase init error:", error);
        updateConnectionStatus("ðŸ”´ Error: " + error.message);
    }
}

// ===== AUTH HANDLER =====
function handleAuthStateChange(user) {
    if (user) {
        // User is signed in
        currentUser = user;
        
        document.getElementById('userEmail').textContent = `ðŸ‘¤ ${user.email}`;
        document.getElementById('userUID').textContent = `UID: ${user.uid.substring(0, 12)}...`;
        
        updateDebugInfo(`âœ… User authenticated: ${user.email}`);
        
        // Save user info to localStorage
        localStorage.setItem('currentUser', JSON.stringify({
            email: user.email,
            uid: user.uid,
            lastLogin: new Date().toISOString()
        }));
        
        // Load user data
        loadUserData();
        
    } else {
        // User is signed out
        currentUser = null;
        document.getElementById('userEmail').textContent = "Belum login";
        document.getElementById('userUID').textContent = "";
        
        // Clear balance display
        document.getElementById('saldoGOV').textContent = "0 GOV";
        document.getElementById('saldoIDR').textContent = "Rp 0";
        document.getElementById('saldoUSDT').textContent = "0.00 USDT";
    }
}

// ===== LOAD USER DATA =====
async function loadUserData() {
    if (!currentUser || !database) {
        updateDebugInfo("Cannot load data: No user/database");
        return;
    }
    
    showSyncIndicator("Memuat data...");
    
    try {
        const userRef = database.ref('users/' + currentUser.uid);
        const snapshot = await userRef.once('value');
        
        if (snapshot.exists()) {
            const data = snapshot.val();
            
            currentBalance = {
                GOV: data.saldoGOV || 0,
                IDR: data.saldoIDR || 0,
                USDT: data.saldoUSDT || 0
            };
            
            updateDisplay();
            updateDebugInfo(`âœ… Data loaded from server: ${new Date(data.lastUpdated || Date.now()).toLocaleString()}`);
            
        } else {
            // Create initial data for new user
            currentBalance = { GOV: 1000, IDR: 50000, USDT: 5.5 };
            
            await saveUserData();
            updateDebugInfo("âœ… Initial data created for new user");
        }
        
    } catch (error) {
        console.error("Load error:", error);
        updateDebugInfo("âŒ Load failed: " + error.message);
        
        // Try to load from localStorage
        const savedData = localStorage.getItem('userBalance_' + currentUser.uid);
        if (savedData) {
            try {
                currentBalance = JSON.parse(savedData);
                updateDisplay();
                updateDebugInfo("ðŸ“‚ Loaded from localStorage (offline)");
            } catch (e) {
                // Ignore
            }
        }
    }
    
    hideSyncIndicator();
}

// ===== SAVE USER DATA =====
async function saveUserData() {
    if (!currentUser || !database) {
        updateDebugInfo("Cannot save: No user/database");
        return false;
    }
    
    showSyncIndicator("Menyimpan ke server...");
    
    try {
        const userRef = database.ref('users/' + currentUser.uid);
        
        await userRef.set({
            email: currentUser.email,
            saldoGOV: currentBalance.GOV,
            saldoIDR: currentBalance.IDR,
            saldoUSDT: currentBalance.USDT,
            lastUpdated: new Date().toISOString(),
            lastDevice: navigator.userAgent.substring(0, 100),
            syncCount: (await userRef.child('syncCount').once('value')).val() || 0 + 1
        });
        
        // Also save to localStorage as backup
        localStorage.setItem('userBalance_' + currentUser.uid, JSON.stringify(currentBalance));
        
        updateDebugInfo(`âœ… Data saved to server: ${new Date().toLocaleTimeString()}`);
        hideSyncIndicator();
        return true;
        
    } catch (error) {
        console.error("Save error:", error);
        updateDebugInfo("âŒ Save failed: " + error.message);
        hideSyncIndicator();
        return false;
    }
}

// ===== UPDATE BALANCE =====
async function tambahSaldo(type, amount) {
    if (!currentUser) {
        alert("âš ï¸ Silakan login terlebih dahulu!\n\nKlik 'Login Test' untuk login otomatis.");
        return;
    }
    
    // Update local balance
    switch(type) {
        case 'GOV':
            currentBalance.GOV += amount;
            break;
        case 'IDR':
            currentBalance.IDR += amount;
            break;
        case 'USDT':
            currentBalance.USDT += amount;
            break;
    }
    
    // Update display immediately
    updateDisplay();
    
    // Save to server
    const saved = await saveUserData();
    
    if (saved) {
        alert(`âœ… ${type} berhasil ditambahkan!\n\n` +
              `Saldo baru: ${getBalanceText(type)}\n\n` +
              `ðŸŽ‰ Data sudah disimpan di SERVER dan bisa diakses di HP lain!`);
    } else {
        alert(`âš ï¸ ${type} ditambahkan (hanya lokal)\n\n` +
              `Saldo baru: ${getBalanceText(type)}\n\n` +
              `ðŸ”´ Gagal sync ke server. Coba lagi nanti.`);
    }
}

// ===== HELPER FUNCTIONS =====
function updateDisplay() {
    document.getElementById('saldoGOV').textContent = 
        currentBalance.GOV.toLocaleString('id-ID') + ' GOV';
    document.getElementById('saldoIDR').textContent = 
        'Rp ' + currentBalance.IDR.toLocaleString('id-ID');
    document.getElementById('saldoUSDT').textContent = 
        currentBalance.USDT.toFixed(2) + ' USDT';
}

function getBalanceText(type) {
    switch(type) {
        case 'GOV': return currentBalance.GOV.toLocaleString('id-ID') + ' GOV';
        case 'IDR': return 'Rp ' + currentBalance.IDR.toLocaleString('id-ID');
        case 'USDT': return currentBalance.USDT.toFixed(2) + ' USDT';
    }
}

function updateConnectionStatus(text) {
    const statusEl = document.getElementById('connectionStatus');
    statusEl.textContent = text;
    
    if (text.includes('ðŸŸ¢') || text.includes('Terhubung')) {
        statusEl.className = 'status online';
    } else {
        statusEl.className = 'status offline';
    }
}

function updateDebugInfo(text) {
    document.getElementById('debugInfo').innerHTML = text;
    console.log('[Wallet]', text);
}

function showSyncIndicator(text) {
    const indicator = document.getElementById('syncIndicator');
    indicator.textContent = text;
    indicator.style.display = 'block';
}

function hideSyncIndicator() {
    const indicator = document.getElementById('syncIndicator');
    indicator.style.display = 'none';
}

// ===== AUTH FUNCTIONS =====
async function loginTest() {
    showSyncIndicator("Logging in...");
    
    try {
        // Try to login with existing user
        const userCredential = await auth.signInWithEmailAndPassword(
            "ddd3@gmail.com",
            "password123" // Use the password you set
        );
        
        alert(`âœ… Login berhasil!\n\nEmail: ${userCredential.user.email}\n\n` +
              `Sekarang saldo akan sync otomatis ke server!`);
        
    } catch (error) {
        console.error("Login error:", error);
        
        if (error.code === 'auth/user-not-found') {
            // Create new user
            try {
                const userCredential = await auth.createUserWithEmailAndPassword(
                    "ddd3@gmail.com",
                    "password123"
                );
                
                alert(`âœ… Akun baru dibuat!\n\nEmail: ${userCredential.user.email}\n\n` +
                      `Password: password123\n\nSimpan info login ini!`);
                
            } catch (createError) {
                alert("âŒ Gagal membuat akun: " + createError.message);
            }
        } else if (error.code === 'auth/wrong-password') {
            alert("âŒ Password salah!\n\nPassword default: password123");
        } else {
            alert("âŒ Login error: " + error.message);
        }
    }
    
    hideSyncIndicator();
}

function logout() {
    if (confirm("Yakin ingin logout?")) {
        auth.signOut();
        localStorage.removeItem('currentUser');
        alert("Logged out. Data tetap aman di server.");
    }
}

// ===== REAL-TIME SYNC LISTENER =====
function setupRealtimeListener() {
    if (!currentUser || !database) return;
    
    const userRef = database.ref('users/' + currentUser.uid);
    
    userRef.on('value', (snapshot) => {
        if (snapshot.exists()) {
            const data = snapshot.val();
            
            // Update local balance if different
            if (data.saldoGOV !== currentBalance.GOV || 
                data.saldoIDR !== currentBalance.IDR || 
                data.saldoUSDT !== currentBalance.USDT) {
                
                currentBalance = {
                    GOV: data.saldoGOV || 0,
                    IDR: data.saldoIDR || 0,
                    USDT: data.saldoUSDT || 0
                };
                
                updateDisplay();
                updateDebugInfo(`ðŸ”„ Real-time update: ${new Date().toLocaleTimeString()}`);
            }
        }
    });
}

// ===== INITIALIZE ON LOAD =====
document.addEventListener('DOMContentLoaded', initializeFirebase);

// Auto-check connection
setInterval(() => {
    if (database && currentUser) {
        database.ref('.info/connected').on('value', (snapshot) => {
            if (snapshot.val() === true) {
                updateConnectionStatus("ðŸŸ¢ Terhubung ke Server");
            } else {
                updateConnectionStatus("ðŸ”´ Offline Mode");
            }
        });
    }
}, 5000);
</script>

</body>
</html>
